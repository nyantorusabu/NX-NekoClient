window.addEventListener("DOMContentLoaded",(()=>{const{createClient:e}=window.supabase,t=e("https://mnvdpvsivqqbzbtjtpws.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1udmRwdnNpdnFxYnpidGp0cHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNTM0MTIsImV4cCI6MjA2ODgyOTQxMn0.v5tAGcd0K4VW9yR1CZYVjMYHLhWJXN7Tz5j9DNf1CQE");let n,o=[],i=null,a=null,s="foryou",r=null,d=null,l=null,c=!1,m=null,p=null,u=new Map,g=!1,f={page:0,hasMore:!0,type:null,options:{}};const h=15,y={home:'<svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><rect x="9" y="12" width="6" height="10"></rect></svg>',dm:'<svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>',send:'<svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>',explore:'<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',notifications:'<svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>',likes:'<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',stars:'<svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',profile:'<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',settings:'<svg viewBox="0 0 24 24"><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0 .33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path><circle cx="12" cy="12" r="3"></circle></svg>',attachment:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>',back:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',reply:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',copy:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',repost:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2l4 4-4 4"></path><path d="M3 11v-1a4 4 0 0 1 4-4h14"></path><path d="M7 22l-4-4 4-4"></path><path d="M21 13v1a4 4 0 0 1-4 4H3"></path></svg>'},v={mainContent:document.getElementById("main-content"),navMenuTop:document.getElementById("nav-menu-top"),navMenuBottom:document.getElementById("nav-menu-bottom"),pageHeader:document.getElementById("page-header"),screens:document.querySelectorAll(".screen"),postFormContainer:document.querySelector(".post-form-container"),postModal:document.getElementById("post-modal"),editPostModal:document.getElementById("edit-post-modal"),editPostModalContent:document.getElementById("edit-post-modal-content"),createDmModal:document.getElementById("create-dm-modal"),createDmModalContent:document.getElementById("create-dm-modal-content"),dmManageModal:document.getElementById("dm-manage-modal"),dmManageModalContent:document.getElementById("dm-manage-modal-content"),editDmMessageModal:document.getElementById("edit-dm-message-modal"),editDmMessageModalContent:document.getElementById("edit-dm-message-modal-content"),connectionErrorOverlay:document.getElementById("connection-error-overlay"),retryConnectionBtn:document.getElementById("retry-connection-btn"),friezeOverlay:document.getElementById("frieze-overlay"),friezeReason:document.getElementById("frieze-reason"),imagePreviewModal:document.getElementById("image-preview-modal"),imagePreviewModalContent:document.getElementById("image-preview-modal-content"),timeline:document.getElementById("timeline"),exploreContent:document.getElementById("explore-content"),notificationsContent:document.getElementById("notifications-content"),likesContent:document.getElementById("likes-content"),starsContent:document.getElementById("stars-content"),postDetailContent:document.getElementById("post-detail-content"),searchResultsScreen:document.getElementById("search-results-screen"),searchResultsContent:document.getElementById("search-results-content"),dmScreen:document.getElementById("dm-screen"),dmContent:document.getElementById("dm-content"),loadingOverlay:document.getElementById("loading-overlay"),loginBanner:document.getElementById("login-banner"),rightSidebar:{recommendations:document.getElementById("recommendations-widget-container"),searchWidget:document.getElementById("right-sidebar-search-widget-container")}};function w(e){v.loadingOverlay.classList.toggle("hidden",!e)}function b(e){v.screens.forEach((e=>{e.classList.contains("hidden")||e.classList.add("hidden")}));const t=document.getElementById(e);t&&t.classList.remove("hidden")}function _(e){if("string"!=typeof e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function M(e){if(!e)return"favicon.png";if(e.icon_data){if(e.icon_data.startsWith("data:image"))return e.icon_data;{const{data:n}=t.storage.from("nyax").getPublicUrl(e.icon_data);return n.publicUrl}}return`https://trampoline.turbowarp.org/avatars/by-username/${e.scid}`}function $(e){if("system"===e.type){return`<div class="dm-system-message">${L(e.content,u)}</div>`}let n="";if(e.attachments&&e.attachments.length>0){n+='<div class="attachments-container">';for(const o of e.attachments){const{data:e}=t.storage.from("nyax").getPublicUrl(o.id),i=e.publicUrl;let a='<div class="attachment-item">';"image"===o.type?a+=`<img src="${i}" alt="${_(o.name)}" class="attachment-image" onclick="event.stopPropagation(); window.openImageModal('${i}')">`:"video"===o.type?a+=`<video src="${i}" controls onclick="event.stopPropagation();"></video>`:"audio"===o.type&&(a+=`<audio src="${i}" controls onclick="event.stopPropagation();"></audio>`),a+=`<a href="#" class="attachment-download-link" onclick="event.preventDefault(); event.stopPropagation(); window.handleDownload('${i}', '${_(o.name)}')">ğŸ“„ ${_(o.name)}</a>`,a+="</div>",n+=a}n+="</div>"}const o=e.content?L(e.content,u):"";if(e.userid===i.id)return`<div class="dm-message-container sent" data-message-id="${e.id}">\n                <div class="dm-message-wrapper">\n                    <button class="dm-message-menu-btn">â€¦</button>\n                    <div class="post-menu">\n                        <button class="edit-dm-msg-btn">ç·¨é›†</button>\n                        <button class="delete-dm-msg-btn delete-btn">å‰Šé™¤</button>\n                    </div>\n                    <div class="dm-message">${o}${n}</div>\n                </div>\n            </div>`;{const t=u.get(e.userid)||{},i=new Date(e.time).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});return`<div class="dm-message-container received">\n                <a href="#profile/${t.id}" class="dm-user-link">\n                    <img src="${M(t)}" class="dm-message-icon">\n                </a>\n                <div class="dm-message-wrapper">\n                    <div class="dm-message-meta">\n                        <a href="#profile/${t.id}" class="dm-user-link">${_(t.name||"ä¸æ˜")}</a>\n                        ãƒ»${i}\n                    </div>\n                    <div class="dm-message">${o}${n}</div>\n                </div>\n            </div>`}}function x(e,t){e.classList.remove("follow-button-not-following","follow-button-following"),t?(e.textContent="ãƒ•ã‚©ãƒ­ãƒ¼ä¸­",e.classList.add("follow-button-following"),e.onmouseenter=()=>{e.textContent="ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤"},e.onmouseleave=()=>{e.textContent="ãƒ•ã‚©ãƒ­ãƒ¼ä¸­"}):(e.textContent="ãƒ•ã‚©ãƒ­ãƒ¼",e.classList.add("follow-button-not-following"),e.onmouseenter=null,e.onmouseleave=null),e.disabled=!1}async function E(e,n,o=""){if(i&&e&&n&&e!==i.id)try{const{error:i}=await t.rpc("send_notification_with_timestamp",{recipient_id:e,message_text:n,open_hash:o});i&&console.error("é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:",i)}catch(e){console.error("é€šçŸ¥é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:",e)}}function L(e,t=new Map){return(e=>{let n=_(e);const o=[];n=n.replace(/(https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&//=;]*))/g,(e=>{const t=`%%URL_${o.length}%%`;return o.push(e),t}));n=n.replace(/(?<!\w)_([a-zA-Z0-9_!?.-]+)_(?!\w)/g,((e,t)=>{const n=_(t);return`<img src="/emoji/${n}.svg" alt="${n}" style="height: 1.2em; vertical-align: -0.2em; margin: 0 0.05em;" class="nyax-emoji">`}));n=n.replace(/#(\S+)/g,((e,t)=>`<a href="#search/${encodeURIComponent(t)}" onclick="event.stopPropagation()">#${t}</a>`));return n=n.replace(/@(\d+)/g,((e,n)=>{const o=parseInt(n);if(t.has(o)){const e=t.get(o);return`<a href="#profile/${o}" onclick="event.stopPropagation()">@${_(e?e.name:`user${o}`)}</a>`}return e})),o.forEach(((e,t)=>{const o=`%%URL_${t}%%`,i=`<a href="${e}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">${_(e)}</a>`;n=n.replace(o,i)})),n.replace(/\n/g,"<br>")})(e)}async function k(){w(!0),g=!1;const e=document.getElementById("profile-sub-tabs-container");e&&e.remove(),await C();const o=window.location.hash||"#";n&&n.disconnect();try{if(o.startsWith("#post/"))await async function(e){v.pageHeader.innerHTML=`\n            <div class="header-with-back-button">\n                <button class="header-back-btn" onclick="window.history.back()">${y.back}</button>\n                <h2 id="page-title">ãƒã‚¹ãƒˆ</h2>\n            </div>`,b("post-detail-screen");const n=v.postDetailContent;n.innerHTML='<div class="spinner"></div>';try{const{data:o,error:i}=await t.from("post").select("content, repost_to").eq("id",e).single();if(i||!o)throw new Error("ãƒã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");if(o.repost_to&&!o.content)return void window.location.replace(`#post/${o.repost_to}`);const{data:a,error:s}=await t.rpc("get_hydrated_posts",{p_post_ids:[e]});if(s||!a||0===a.length)throw s||new Error("ãƒã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");const r=a[0],{data:d,error:l}=await t.rpc("get_all_replies",{root_post_id:e});if(l)throw l;const c=new Set([r.id,...d.map((e=>e.id))]);r.reposted_post&&c.add(r.reposted_post.id),r.reply_to_post&&c.add(r.reply_to_post.id);const m=Array.from(c),[{data:p},{data:g},{data:f},{data:h}]=await Promise.all([t.rpc("get_reply_counts",{post_ids:m}),t.rpc("get_like_counts_for_posts",{p_post_ids:m}),t.rpc("get_star_counts_for_posts",{p_post_ids:m}),t.rpc("get_repost_counts_for_posts",{p_post_ids:m})]),y=new Map(p.map((e=>[e.post_id,e.reply_count]))),v=new Map(g.map((e=>[e.post_id,e.like_count]))),w=new Map(f.map((e=>[e.post_id,e.star_count]))),b=new Map(h.map((e=>[e.post_id,e.repost_count]))),_=new Set,M=/@(\d+)/g,$=e=>{if(!e)return;const t=e.matchAll(M);for(const e of t)_.add(parseInt(e[1]))};$(r.content),r.reply_to&&$(r.reply_to.content),d.forEach((e=>$(e.content)));const x=[..._].filter((e=>e&&!u.has(e)));if(x.length>0){const{data:e}=await t.from("user").select("id, name, scid, icon_data").in("id",x);e&&e.forEach((e=>u.set(e.id,e)))}if(n.innerHTML="",r.reply_to_post){r.reply_to_post.like=v.get(r.reply_to_post.id)||0,r.reply_to_post.star=w.get(r.reply_to_post.id)||0,r.reply_to_post.repost_count=b.get(r.reply_to_post.id)||0;const e=await U(r.reply_to_post,r.reply_to_post.author,{userCache:u,replyCountsMap:y});if(e){const t=document.createElement("div");t.className="parent-post-container",t.appendChild(e),n.appendChild(t)}}r.reposted_post&&(r.reposted_post.like=v.get(r.reposted_post.id)||0,r.reposted_post.star=w.get(r.reposted_post.id)||0,r.reposted_post.repost_count=b.get(r.reposted_post.id)||0),r.like=v.get(r.id)||0,r.star=w.get(r.id)||0,r.repost_count=b.get(r.id)||0;const E=await U(r,r.author,{userCache:u,replyCountsMap:y});E&&n.appendChild(E);const L=document.createElement("h3");L.textContent="è¿”ä¿¡",L.style.cssText="padding: 1rem; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin-top: 1rem; margin-bottom: 0; font-size: 1.2rem;",n.appendChild(L);const k=new Map;d.forEach((e=>{const t=e.reply_id;k.has(t)||k.set(t,[]),k.get(t).push(e)}));for(const e of k.values())e.sort(((e,t)=>new Date(e.time)-new Date(t.time)));const C=[],T=e=>{const t=k.get(e)||[];for(const e of t)C.push(e),T(e.id)};T(e);const H=document.createElement("div");n.appendChild(H);const I=document.createElement("div");I.className="load-more-trigger",n.appendChild(I);let q={page:0,hasMore:C.length>0};const S=10;let B=!1;const D=async()=>{if(B||!q.hasMore)return;B=!0,I.innerHTML='<div class="spinner"></div>';const t=q.page*S,n=t+S,o=C.slice(t,n);for(const t of o){const n={...t,like:v.get(t.id)||0,star:w.get(t.id)||0,repost_count:b.get(t.id)||0},o={id:t.author_id,name:t.author_name,scid:t.author_scid,icon_data:t.author_icon_data,admin:t.author_admin,verify:t.author_verify};t.reply_id!==e&&t.reply_to_user_id&&(n.reply_to={user:{id:t.reply_to_user_id,name:t.reply_to_user_name}});const i=t.reply_id===e,a=await U(n,o,{userCache:u,replyCountsMap:y,isDirectReply:i});a&&(t.reply_id!==e&&a.classList.add("grandchild-reply"),H.appendChild(a))}q.page++,q.page*S>=d.length&&(q.hasMore=!1),q.hasMore?I.innerHTML="":(I.textContent=H.hasChildNodes()?"ã™ã¹ã¦ã®è¿”ä¿¡ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ":"ã¾ã è¿”ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",N&&N.disconnect()),B=!1},N=new IntersectionObserver((e=>{e[0].isIntersecting&&D()}),{rootMargin:"200px"});N.observe(I)}catch(e){console.error("Post detail error:",e),n.innerHTML=`<p class="error-message">${e.message||"ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"}</p>`}finally{w(!1)}}(o.substring(6));else if(o.startsWith("#profile/")){const e=o.substring(9),n=parseInt(e,10);if(isNaN(n))return void(window.location.hash="#");const a=e.match(/\/(.+)/),s=a?a[1]:"posts";await async function(e,n="posts"){v.pageHeader.innerHTML=`\n            <div class="header-with-back-button">\n                <button class="header-back-btn" onclick="window.history.back()">${y.back}</button>\n                <h2 id="page-title">\n                    <div id="page-title-main">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>\n                    <small id="page-title-sub"></small>\n                </h2>\n            </div>`,b("profile-screen");const o=document.getElementById("profile-header"),a=document.getElementById("profile-tabs");document.querySelector(".frieze-notice")?.remove(),document.getElementById("profile-content").innerHTML="",o.innerHTML='<div class="spinner"></div>',a.innerHTML="";try{const{data:s,error:r}=await t.from("user").select("*").eq("id",e).single();if(r||!s)return o.innerHTML="<h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2>",void w(!1);if(s.frieze){document.getElementById("page-title-main").textContent=s.name,document.getElementById("page-title-sub").textContent=`#${s.id}`,o.innerHTML=`\n                    <div class="header-top">\n                        <img src="${M(s)}" class="user-icon-large" alt="${s.name}'s icon">\n                    </div>\n                    <div class="profile-info">\n                        <h2>${_(s.name)}</h2>\n                        <div class="user-id">#${s.id}</div>\n                    </div>`;const e=document.createElement("div");return e.className="frieze-notice",e.innerHTML='ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯<a href="rule" target="_blank" rel="noopener noreferrer">NyaXãƒ«ãƒ¼ãƒ«</a>ã«é•åã—ãŸãŸã‚å‡çµã•ã‚Œã¦ã„ã¾ã™ã€‚',a.innerHTML="",a.insertAdjacentElement("afterend",e),void w(!1)}const{data:d,error:l}=await t.rpc("get_user_post_count",{p_user_id:e});s.postCount=l?0:d;const{data:c,error:m}=await t.rpc("get_user_media_count",{p_user_id:e});s.mediaCount=m?0:c;const{data:p,error:u}=await t.rpc("get_follower_count",{target_user_id:e}),g=u?"?":p,f=_(s.me||"").replace(/\n/g,"<br>");if(o.innerHTML=`\n                <div class="header-top">\n                    <img src="${M(s)}" class="user-icon-large" alt="${s.name}'s icon">\n                    <div id="profile-actions" class="profile-actions"></div>\n                </div>\n                <div class="profile-info">\n                    <h2>\n                        ${_(s.name)}\n                        ${s.admin?'<img src="icons/admin.png" class="admin-badge" title="NyaXTeam">':s.verify?'<img src="icons/verify.png" class="verify-badge" title="èªè¨¼æ¸ˆã¿">':""}\n                    </h2>\n                    <div class="user-id">#${s.id} ${s.settings.show_scid?`(@${s.scid})`:""}</div>\n                    <p class="user-me">${f}</p>\n                    <div class="user-stats">\n                        <a href="#profile/${s.id}/following"><strong>${s.follow?.length||0}</strong> ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</a>\n                        <a href="#profile/${s.id}/followers" id="follower-count"><strong>${g}</strong> ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</a>\n                    </div>\n                </div>`,i&&e!==i.id){const n=o.querySelector("#profile-actions");if(n){const o=document.createElement("button");o.className="dm-button",o.title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡",o.innerHTML=y.dm,o.onclick=()=>G(e),n.appendChild(o);const a=document.createElement("button"),r=i.follow?.includes(e);if(x(a,r),a.classList.add("profile-follow-button"),a.onclick=()=>window.handleFollowToggle(e,a),n.appendChild(a),i.admin){const e=document.createElement("button");e.className="dm-button",e.innerHTML="â€¦",e.onclick=e=>{e.stopPropagation(),function(e,n){document.getElementById("admin-profile-menu")?.remove();const o=document.createElement("div");o.id="admin-profile-menu",o.className="post-menu is-visible";const i=document.createElement("button");i.textContent=n.verify?"èªè¨¼ã‚’å–ã‚Šæ¶ˆã™":"ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼",i.onclick=()=>async function(e){const n=!e.verify,o=n?"èªè¨¼":"èªè¨¼ã®å–ã‚Šæ¶ˆã—";if(confirm(`æœ¬å½“ã«ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®${o}ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ`)){const{error:i}=await t.from("user").update({verify:n}).eq("id",e.id);i?alert(`${o}ã«å¤±æ•—ã—ã¾ã—ãŸ: ${i.message}`):(alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®${o}ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`),window.location.reload())}}(n);const a=document.createElement("button");a.textContent="é€šçŸ¥ã‚’é€ä¿¡",a.onclick=()=>async function(e){const t=prompt("é€ä¿¡ã™ã‚‹é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");t&&t.trim()&&(await E(e,`${t.trim()} - NyaXTeam`),alert("é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚"))}(n.id);const s=document.createElement("button");s.textContent="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‡çµ",s.className="delete-btn",s.onclick=()=>async function(e){const n=prompt("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‡çµç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (å¿…é ˆ):");if(n&&n.trim()){if(confirm(`æœ¬å½“ã«ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‡çµã—ã¾ã™ã‹ï¼Ÿ\nç†ç”±: ${n}`)){const{error:o}=await t.from("user").update({frieze:n.trim()}).eq("id",e);o?alert(`å‡çµã«å¤±æ•—ã—ã¾ã—ãŸ: ${o.message}`):(alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‡çµã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚"),window.location.reload())}}else alert("å‡çµç†ç”±ã®å…¥åŠ›ã¯å¿…é ˆã§ã™ã€‚")}(n.id),o.appendChild(i),o.appendChild(a),o.appendChild(s),document.body.appendChild(o);const r=e.getBoundingClientRect();o.style.position="absolute",o.style.top=`${window.scrollY+r.bottom}px`,o.style.left=`${window.scrollX+r.left}px`,o.style.right="auto",setTimeout((()=>{document.addEventListener("click",(()=>o.remove()),{once:!0})}),0)}(e.currentTarget,s)},n.appendChild(e)}}}const h=[{key:"posts",name:"ãƒã‚¹ãƒˆ"},{key:"replies",name:"è¿”ä¿¡",className:"mobile-hidden"},{key:"media",name:"ãƒ¡ãƒ‡ã‚£ã‚¢"},{key:"likes",name:"ã„ã„ã­"},{key:"stars",name:"ãŠæ°—ã«å…¥ã‚Š"}];a.innerHTML=h.map((e=>`<button class="tab-button ${e.className||""} ${e.key===n?"active":""}" data-tab="${e.key}">${e.name}</button>`)).join(""),a.querySelectorAll(".tab-button").forEach((e=>{e.onclick=t=>{t.stopPropagation(),O(s,e.dataset.tab)}})),await O(s,n)}catch(e){o.innerHTML="<h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h2>",console.error(e)}finally{w(!1)}}(n,s)}else o.startsWith("#search/")?await async function(e){v.pageHeader.innerHTML=`<h2 id="page-title">æ¤œç´¢çµæœ: "${_(e)}"</h2>`,b("search-results-screen");const n=v.searchResultsContent;n.innerHTML="";const o=document.createElement("div");n.appendChild(o);const i=document.createElement("div");n.appendChild(i),o.innerHTML='<div class="spinner"></div>';const{data:a,error:s}=await t.from("user").select("id, name, scid, me, icon_data").or(`name.ilike.%${e}%,scid.ilike.%${e}%,me.ilike.%${e}%`).order("id",{ascending:!0}).limit(10);s&&console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚¨ãƒ©ãƒ¼:",s);o.innerHTML=`<h3 style="padding:1rem;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ (${a?.length||0}ä»¶)</h3>`,a&&a.length>0?a.forEach((e=>{const t=document.createElement("div");t.className="profile-card widget-item";const n=document.createElement("a");n.href=`#profile/${e.id}`,n.className="profile-link",n.style.cssText="display:flex; align-items:center; gap:0.8rem; text-decoration:none; color:inherit;",n.innerHTML=`<img src="${M(e)}" style="width:48px; height:48px; border-radius:50%;" alt="${e.name}'s icon"><div><span class="name" style="font-weight:700;">${_(e.name)}</span><span class="id" style="color:var(--secondary-text-color);">#${e.id}</span><p class="me" style="margin:0.2rem 0 0;">${_(e.me||"")}</p></div>`,t.appendChild(n),o.appendChild(t)})):o.innerHTML+='<p style="padding:1rem; text-align:center;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';i.innerHTML='<h3 style="padding:1rem; border-top:1px solid var(--border-color); margin-top:1rem; padding-top:1rem;">ãƒã‚¹ãƒˆ</h3>',await F(i,"search",{query:e}),w(!1)}(decodeURIComponent(o.substring(8))):"#admin/logs"===o&&i?.admin?await async function(){v.pageHeader.innerHTML=`\n        <div class="header-with-back-button">\n            <button class="header-back-btn" onclick="window.history.back()">${y.back}</button>\n            <h2 id="page-title">ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°</h2>\n        </div>`,b("admin-logs-screen");const e=document.getElementById("admin-logs-content");e.innerHTML="",g=!1;const o=40;let i=0,a=!0;const s=document.createElement("div");s.className="load-more-trigger",e.appendChild(s);const r=async()=>{if(g||!a)return;g=!0,s.innerHTML='<div class="spinner"></div>';const r=i*o,{data:d,error:l}=await t.rpc("get_logs_with_masked_ip",{p_limit:o,p_offset:r});if(l)return console.error("ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—:",l),s.innerHTML=`<p class="error-message">${l.message}</p>`,a=!1,void(g=!1);d&&d.length>0&&(d.forEach((t=>{const n=document.createElement("div");n.className="widget-item",n.style.cssText="display: flex; flex-direction: column; gap: 0.25rem;",n.innerHTML=`\n                    <div>\n                        <strong>SCID:</strong> ${_(t.scratch_id)} (#${t.nyax_id})\n                    </div>\n                    <div style="font-size: 0.9rem; color: var(--secondary-text-color);">\n                        ${new Date(t.log_time).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo"})}\n                    </div>\n                    <div style="font-size: 0.8rem; color: var(--secondary-text-color); font-family: monospace; word-break: break-all;">\n                        è­˜åˆ¥å­: ${t.masked_ip_uuid}\n                    </div>\n                `,e.insertBefore(n,s)})),i++),!d||d.length<o?(a=!1,s.innerHTML=e.children.length>1?"ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ":"ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚",n&&n.disconnect()):s.innerHTML="",g=!1};n=new IntersectionObserver((e=>{e[0].isIntersecting&&r()}),{rootMargin:"200px"}),n.observe(s),w(!1)}():o.startsWith("#dm/")?await j(o.substring(4)):"#dm"===o?await j():"#settings"===o&&i?await async function(){if(!i)return k();v.pageHeader.innerHTML='<h2 id="page-title">è¨­å®š</h2>',b("settings-screen"),l=null,c=!1,document.getElementById("settings-screen").innerHTML=`\n        <form id="settings-form">\n            <label for="setting-username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>\n            <input type="text" id="setting-username" required value="${_(i.name)}">\n            \n            <label for="setting-icon-input">ã‚¢ã‚¤ã‚³ãƒ³:</label>\n            <div class="setting-icon-container">\n                <img id="setting-icon-preview" src="${M(i)}" alt="icon preview" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ">\n                <button type="button" id="reset-icon-btn">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>\n            </div>\n            <input type="file" id="setting-icon-input" accept="image/*" class="hidden">\n\n            <label for="setting-me">è‡ªå·±ç´¹ä»‹:</label>\n            <textarea id="setting-me">${_(i.me||"")}</textarea>\n\n            <label for="setting-default-timeline">ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ–:</label>\n            <select id="setting-default-timeline" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;">\n                <option value="all">ã™ã¹ã¦</option>\n                <option value="foryou">ãŠã™ã™ã‚(Î²)</option>\n                <option value="following">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</option>\n            </select>\n            \n            <fieldset><legend>å…¬é–‹è¨­å®š</legend>\n                <input type="checkbox" id="setting-show-like" ${i.settings.show_like?"checked":""}><label for="setting-show-like">ã„ã„ã­ã—ãŸãƒã‚¹ãƒˆã‚’å…¬é–‹ã™ã‚‹</label><br>\n                <input type="checkbox" id="setting-show-follow" ${i.settings.show_follow?"checked":""}><label for="setting-show-follow">ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹äººã‚’å…¬é–‹ã™ã‚‹</label><br>\n                <input type="checkbox" id="setting-show-follower" ${i.settings.show_follower??1?"checked":""}><label for="setting-show-follower">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªã‚¹ãƒˆã‚’å…¬é–‹ã™ã‚‹</label><br>\n                <input type="checkbox" id="setting-show-star" ${i.settings.show_star?"checked":""}><label for="setting-show-star">ãŠæ°—ã«å…¥ã‚Šã‚’å…¬é–‹ã™ã‚‹</label><br>\n                <input type="checkbox" id="setting-show-scid" ${i.settings.show_scid?"checked":""}><label for="setting-show-scid">Scratchã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¬é–‹ã™ã‚‹</label>\n            </fieldset>\n            <button type="submit">è¨­å®šã‚’ä¿å­˜</button>\n        </form>\n        <div class="settings-danger-zone" style="display: flex; gap: 0.5rem;">\n            \x3c!-- ãƒœã‚¿ãƒ³ã¯JSã§å‹•çš„ã«æŒ¿å…¥ã—ã¾ã™ --\x3e\n        </div>\n        `;const e=i.settings?.default_timeline_tab||"all";document.getElementById("setting-default-timeline").value=e;const t=document.querySelector(".settings-danger-zone");let n='<button id="settings-logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>';i.admin&&(n+='\n            <a href="#admin/logs" id="settings-showlog-btn">\n                ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°\n            </a>\n        ');t.innerHTML=n;const o=document.getElementById("setting-icon-input"),a=document.getElementById("setting-icon-preview");a.addEventListener("click",(()=>o.click())),o.addEventListener("change",(e=>{const t=e.target.files[0];if(!t||!t.type.startsWith("image/"))return;c=!1;const n=new FileReader;n.onload=e=>{const n=new Image;n.onload=()=>{const e=300;let{width:o,height:i}=n;(o>e||i>e)&&(o>i?(i=Math.round(i*e/o),o=e):(o=Math.round(o*e/i),i=e));const s=document.createElement("canvas");s.width=o,s.height=i;s.getContext("2d").drawImage(n,0,0,o,i),l=s.toDataURL(t.type),a.src=l},n.src=e.target.result},n.readAsDataURL(t)})),document.getElementById("reset-icon-btn").addEventListener("click",(()=>{c=!0,l=null,o.value="",a.src=`https://trampoline.turbowarp.org/avatars/by-username/${i.scid}`})),document.getElementById("settings-form").addEventListener("submit",V),document.getElementById("settings-logout-btn").addEventListener("click",(e=>{H()})),w(!1)}():"#explore"===o?await async function(){v.pageHeader.innerHTML=`\n            <div class="header-search-bar">\n                ${y.explore}\n                <input type="search" id="search-input" placeholder="æ¤œç´¢">\n            </div>`;const e=document.getElementById("search-input"),n=()=>{const t=e.value.trim();t&&(window.location.hash=`#search/${encodeURIComponent(t)}`)};e.onkeydown=e=>{"Enter"===e.key&&n()},b("explore-screen");const o=v.exploreContent;o.innerHTML='<div class="spinner"></div>';try{const{data:e,error:n}=await t.rpc("get_trending_hashtags");if(n)throw n;if(e&&e.length>0){let t='\n                    <div class="trends-widget-container">\n                        <div class="trends-widget-title">ãƒˆãƒ¬ãƒ³ãƒ‰</div>\n                ';e.forEach(((e,n)=>{t+=`\n                        <a href="#search/${encodeURIComponent(e.tag_name)}" class="trend-item">\n                            <div class="trend-item-meta">\n                                <span>${n+1}</span>ä½\n                            </div>\n                            <div class="trend-item-name">#${_(e.tag_name)}</div>\n                            <div class="trend-item-count">${e.occurrence_count}ä»¶ã®ãƒã‚¹ãƒˆ</div>\n                        </a>\n                    `})),t+="</div>",o.innerHTML=t}else o.innerHTML='<p style="padding: 2rem; text-align: center; color: var(--secondary-text-color);">ç¾åœ¨ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}catch(e){console.error("ãƒˆãƒ¬ãƒ³ãƒ‰ã®å–å¾—ã«å¤±æ•—:",e),o.innerHTML='<p style="padding: 2rem; text-align: center; color: var(--secondary-text-color);">ãƒˆãƒ¬ãƒ³ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>'}finally{w(!1)}}():"#notifications"===o&&i?await W():"#likes"===o&&i?await async function(){v.pageHeader.innerHTML='<h2 id="page-title">ã„ã„ã­</h2>',b("likes-screen"),v.likesContent.innerHTML="",await F(v.likesContent,"likes",{ids:i.like}),w(!1)}():"#stars"===o&&i?await async function(){v.pageHeader.innerHTML='<h2 id="page-title">ãŠæ°—ã«å…¥ã‚Š</h2>',b("stars-screen"),v.starsContent.innerHTML="",await F(v.starsContent,"stars",{ids:i.star}),w(!1)}():await async function(){v.pageHeader.innerHTML='<h2 id="page-title">ãƒ›ãƒ¼ãƒ </h2>',b("main-screen");const e=document.querySelector(".timeline-tabs");i?(e.innerHTML='\n                <button class="timeline-tab-button" data-tab="all">ã™ã¹ã¦</button>\n                <button class="timeline-tab-button" data-tab="foryou">ãŠã™ã™ã‚(Î²)</button>\n                <button class="timeline-tab-button" data-tab="following">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>\n            ',s=i.settings?.default_timeline_tab||"all"):(e.innerHTML='\n                <button class="timeline-tab-button" data-tab="all">ã™ã¹ã¦</button>\n            ',s="all");i?(v.postFormContainer.innerHTML=N(),P(v.postFormContainer)):v.postFormContainer.innerHTML="";await X(s),w(!1)}()}catch(e){console.error("Routing error:",e),v.pageHeader.innerHTML="<h2>ã‚¨ãƒ©ãƒ¼</h2>",b("main-screen"),v.timeline.innerHTML='<p class="error-message">ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>'}}async function C(){const e=window.location.hash||"#",n=[{name:"ãƒ›ãƒ¼ãƒ ",hash:"#",icon:y.home},{name:"æ¤œç´¢",hash:"#explore",icon:y.explore}];if(i&&!i.notice_count_fetched_recently){const{data:e,error:n}=await t.from("user").select("notice, notice_count").eq("id",i.id).single();!n&&e&&(i.notice=e.notice,i.notice_count=e.notice_count,localStorage.setItem("currentUser",JSON.stringify(i))),i.notice_count_fetched_recently=!0,setTimeout((()=>{i&&(i.notice_count_fetched_recently=!1)}),1e4)}if(i){const{data:e,error:o}=await t.rpc("get_all_unread_dm_counts",{p_user_id:i.id});let a=0;!o&&e&&(i.unreadDmCountsData=e,a=e.reduce(((e,t)=>e+t.unread_count),0)),n.push({name:"é€šçŸ¥",hash:"#notifications",icon:y.notifications,badge:i.notice_count},{name:"ã„ã„ã­",hash:"#likes",icon:y.likes},{name:"ãŠæ°—ã«å…¥ã‚Š",hash:"#stars",icon:y.stars},{name:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",hash:"#dm",icon:y.dm,badge:a},{name:"ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«",hash:`#profile/${i.id}`,icon:y.profile},{name:"è¨­å®š",hash:"#settings",icon:y.settings})}v.navMenuTop.innerHTML=n.map((t=>{let n=!1;return n="#"===t.hash?"#"===e||""===e:e.startsWith(t.hash),`\n                <a href="${t.hash}" class="nav-item ${n?"active":""}">\n                    <div class="nav-item-icon-container">\n                        ${t.icon}\n                        ${t.badge&&t.badge>0?`<span class="notification-badge">${t.badge>99?"99+":t.badge}</span>`:""}\n                    </div>\n                    <span class="nav-item-text">${t.name}</span>\n                </a>`})).join(""),i&&(v.navMenuTop.innerHTML+=`<button class="nav-item nav-item-post"><span class="nav-item-text">ãƒã‚¹ãƒˆ</span><span class="nav-item-icon">${y.send}</span></button>`),v.navMenuBottom.innerHTML=i?`<button id="account-button" class="nav-item account-button"> <img src="${M(i)}" class="user-icon" alt="${i.name}'s icon"> <div class="account-info"> <span class="name">${_(i.name)}</span> <span class="id">#${i.id}</span> </div> </button>`:"",v.loginBanner.classList.toggle("hidden",!!i),v.navMenuTop.querySelectorAll("a.nav-item").forEach((e=>{e.onclick=e=>{}})),v.navMenuBottom.querySelector("#account-button")?.addEventListener("click",H),v.navMenuTop.querySelector(".nav-item-post")?.addEventListener("click",(()=>q())),async function(){v.rightSidebar.searchWidget&&(v.rightSidebar.searchWidget.innerHTML=` <div class="sidebar-search-widget"> ${y.explore} <input type="search" id="sidebar-search-input" placeholder="æ¤œç´¢"> </div>`,document.getElementById("sidebar-search-input").addEventListener("keydown",(e=>{if("Enter"===e.key){const t=e.target.value.trim();t&&(window.location.hash=`#search/${encodeURIComponent(t)}`)}})));let e=t.from("user").select("id, name, scid, icon_data");i&&(e=e.neq("id",i.id));const{data:n,error:o}=await e.order("time",{ascending:!1}).limit(3);if(o||!n||0===n.length)return void(v.rightSidebar.recommendations&&(v.rightSidebar.recommendations.innerHTML=""));let a='<div class="widget-title">ãŠã™ã™ã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>';a+=n.map((e=>{const t=i?.follow?.includes(e.id),n=t?"follow-button-following":"follow-button-not-following",o=t?"ãƒ•ã‚©ãƒ­ãƒ¼ä¸­":"ãƒ•ã‚©ãƒ­ãƒ¼";return` <div class="widget-item recommend-user"> <a href="#profile/${e.id}" class="profile-link" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:0.5rem;"> <img src="${M(e)}" style="width:40px;height:40px;border-radius:50%;" alt="${e.name}'s icon"> <div> <span>${_(e.name)}</span> <small style="color:var(--secondary-text-color); display:block;">#${e.id}</small> </div> </a> ${i&&i.id!==e.id?`<button class="${n}" data-user-id="${e.id}">${o}</button>`:""} </div>`})).join(""),v.rightSidebar.recommendations&&(v.rightSidebar.recommendations.innerHTML=`<div class="sidebar-widget">${a}</div>`),v.rightSidebar.recommendations?.querySelectorAll(".recommend-user button").forEach((e=>{const t=parseInt(e.dataset.userId);if(!isNaN(t)){const n=i?.follow?.includes(t);x(e,n),e.onclick=()=>window.handleFollowToggle(t,e)}}))}()}function T(){window.location.href="login.html"}function H(){confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")&&t.auth.signOut().then((()=>{i=null,a&&(t.removeChannel(a),a=null),window.location.hash="#",k()}))}async function I(){const{data:{session:e},error:n}=await t.auth.getSession();if(n)return console.error(n),void v.connectionErrorOverlay.classList.remove("hidden");if(e)try{const n=e.user.id,{data:o,error:s}=await t.from("user").select("*").eq("uuid",n).single();if(s||!o)throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");if(i=o,i.frieze)return v.friezeReason.textContent=i.frieze,void v.friezeOverlay.classList.remove("hidden");!function(){if(a)return;a=t.channel("nyax-feed").on("postgres_changes",{event:"INSERT",schema:"public",table:"post"},(async e=>{const t=document.getElementById("main-screen");if(i&&null===e.new.reply_id&&e.new.userid!==i.id&&t&&!t.classList.contains("hidden")&&i.follow?.includes(e.new.userid)){if(document.querySelector(".new-posts-indicator"))return;const e=document.createElement("div");e.className="new-posts-indicator";const n=document.createElement("button");n.textContent="æ–°ã—ã„ãƒã‚¹ãƒˆã‚’è¡¨ç¤º",n.onclick=()=>{e.remove(),k()},e.appendChild(n);const o=t.querySelector(".post-form-sticky-container");o&&t.insertBefore(e,o)}else if(!document.getElementById("post-detail-screen").classList.contains("hidden")){const t=window.location.hash.substring(6);e.new.reply_id===t&&k()}})).on("postgres_changes",{event:"UPDATE",schema:"public",table:"user",filter:`id=eq.${i?.id}`},(e=>{C()})).on("postgres_changes",{event:"UPDATE",schema:"public",table:"dm"},(e=>{if(!i||!e.new.member.includes(i.id))return;const t=window.location.hash.startsWith("#dm/")?window.location.hash.substring(4):null;e.new.id!==t&&C()})).subscribe()}(),k()}catch(e){console.error(e),i=null,v.connectionErrorOverlay.classList.remove("hidden")}else i=null,k()}function q(e=null){if(!i)return T();v.postModal.classList.remove("hidden");const t=v.postModal.querySelector(".post-form-container-modal");if(t.innerHTML=N()+'<div id="quoting-preview-container"></div>',P(t),e){r=e;const n=t.querySelector("#reply-info");n.innerHTML=`<span>@${e.name}ã«è¿”ä¿¡ä¸­</span>`,n.classList.remove("hidden")}if(d){const e=t.querySelector("#quoting-preview-container"),n=document.createElement("div");n.className="nested-repost-container",n.innerHTML=`<div class="post-header"><img src="${M(d.user)}" class="user-icon" style="width:24px;height:24px;"> <span class="post-author">${_(d.user.name)}</span></div><div class="post-content">${_(d.content)}</div>`,e.appendChild(n)}v.postModal.querySelector(".modal-close-btn").onclick=S,t.querySelector("textarea").focus()}function S(){v.postModal.classList.add("hidden"),r=null,d=null,o=[]}const B=e=>{e.ctrlKey&&"Enter"===e.key&&e.target.closest(".post-form").querySelector('button[id^="post-submit-button"]').click()};function D(e,n){S();const o=`repost-menu-${e.id}`;if(document.getElementById(o))return;const a=document.createElement("div");a.id=o,a.className="post-menu is-visible";const s=document.createElement("button");s.textContent="ãƒªãƒã‚¹ãƒˆ",s.onclick=n=>{n.stopPropagation(),async function(e){if(!i)return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");w(!0);try{const{data:n,error:o}=await t.from("post").select("userid").eq("id",e).single();if(o)throw o;const{error:a}=await t.rpc("create_post",{p_content:null,p_reply_id:null,p_repost_to:e,p_attachments:null});if(a)throw a;E(n.userid,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã®ãƒã‚¹ãƒˆã‚’ãƒªãƒã‚¹ãƒˆã—ã¾ã—ãŸã€‚`,`#post/${e}`),k()}catch(e){console.error(e);const t=e.message.replace(/^Error: /,"");alert(`ãƒªãƒã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${t}`)}finally{w(!1)}}(e.id),a.remove()};const r=document.createElement("button");r.textContent="å¼•ç”¨ãƒã‚¹ãƒˆ",r.onclick=t=>{t.stopPropagation(),d=e,q(),a.remove()},a.appendChild(s),a.appendChild(r);const l=n;if(l){document.body.appendChild(a);const e=l.getBoundingClientRect();a.style.position="absolute",a.style.top=window.scrollY+e.top-a.offsetHeight+"px",a.style.left=`${window.scrollX+e.left}px`,a.style.right="auto"}setTimeout((()=>{document.addEventListener("click",(()=>a.remove()),{once:!0})}),0)}function N(){return`\n            <div class="post-form">\n                <img src="${M(i)}" class="user-icon" alt="your icon">\n                <div class="form-content">\n                    <div id="reply-info" class="hidden" style="margin-bottom: 0.5rem; color: var(--secondary-text-color);"></div>\n                    <textarea id="post-content" placeholder="ã„ã¾ã©ã†ã—ã¦ã‚‹ï¼Ÿ" maxlength="280"></textarea>\n                    <div class="file-preview-container"></div>\n                    <div class="post-form-actions">\n                        <button type="button" class="attachment-button" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜">\n                            ${y.attachment}\n                        </button>\n                        <input type="file" id="file-input" class="hidden" multiple>\n                        <button id="post-submit-button">ãƒã‚¹ãƒˆ</button>\n                    </div>\n                </div>\n            </div>`}function P(e){e.querySelector(".attachment-button").addEventListener("click",(()=>{e.querySelector("#file-input").click()})),e.querySelector("#file-input").addEventListener("change",(t=>A(t,e))),e.querySelector("#post-submit-button").addEventListener("click",(()=>async function(e){if(!i)return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");const n=e.querySelector("textarea"),a=n.value.trim();if(!a&&0===o.length&&!d)return alert("å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã—ã¦ãã ã•ã„ã€‚");const s=e.querySelector("#post-submit-button");s.disabled=!0,s.textContent="æŠ•ç¨¿ä¸­...",w(!0);let l=[],c=[];try{if(o.length>0)for(const e of o){const t=await R(e);c.push(t);const n=e.type.startsWith("image/")?"image":e.type.startsWith("video/")?"video":e.type.startsWith("audio/")?"audio":"file";l.push({type:n,id:t,name:e.name})}const{data:s,error:m}=await t.rpc("create_post",{p_content:a,p_reply_id:r?.id||null,p_repost_to:d?.id||null,p_attachments:l.length>0?l:null}).single();if(m)throw m;let p=null;if(r){const{data:e}=await t.from("post").select("userid").eq("id",r.id).single();e&&e.userid!==i.id&&(p=e.userid,E(p,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã®ãƒã‚¹ãƒˆã«è¿”ä¿¡ã—ã¾ã—ãŸã€‚`,`#post/${s.id}`))}const u=/@(\d+)/g,g=new Set;let f;for(;null!==(f=u.exec(a));){const e=parseInt(f[1]);e!==i.id&&e!==p&&g.add(e)}g.forEach((e=>{E(e,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¾ã—ãŸã€‚`,`#post/${s.id}`)})),o=[],n.value="",e.querySelector(".file-preview-container").innerHTML="",e.closest(".modal-overlay")?S():clearReply(),"#"!==window.location.hash&&""!==window.location.hash||await k()}catch(e){console.error("ãƒã‚¹ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:",e),c.length>0&&(console.warn("æŠ•ç¨¿ã«å¤±æ•—ã—ãŸãŸã‚ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™:",c),await z(c)),alert(`æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`)}finally{s.disabled=!1,s.textContent="ãƒã‚¹ãƒˆ",w(!1)}}(e))),e.querySelector("textarea").addEventListener("keydown",B)}function A(e,t){const n=t.querySelector(".file-preview-container");n.innerHTML="",o=Array.from(e.target.files),o.forEach(((e,t)=>{const o=document.createElement("div");if(o.className="file-preview-item",e.type.startsWith("image/")){const i=new FileReader;i.onload=i=>{o.innerHTML=`<img src="${i.target.result}" alt="${e.name}"><button class="file-preview-remove" data-index="${t}">Ã—</button>`,n.appendChild(o)},i.readAsDataURL(e)}else if(e.type.startsWith("video/")){const i=new FileReader;i.onload=e=>{o.innerHTML=`<video src="${e.target.result}" controls></video><button class="file-preview-remove" data-index="${t}">Ã—</button>`,n.appendChild(o)},i.readAsDataURL(e)}else e.type.startsWith("audio/")?(o.innerHTML=`<span>ğŸµ ${_(e.name)}</span><button class="file-preview-remove" data-index="${t}">Ã—</button>`,n.appendChild(o)):(o.innerHTML=`<span>ğŸ“„ ${_(e.name)}</span><button class="file-preview-remove" data-index="${t}">Ã—</button>`,n.appendChild(o))})),n.addEventListener("click",(e=>{if(e.target.classList.contains("file-preview-remove")){const n=parseInt(e.target.dataset.index);o.splice(n,1),A({target:{files:(new DataTransfer).files}},t);const i=new DataTransfer;o.forEach((e=>i.items.add(e))),t.querySelector("#file-input").files=i.files}}))}async function R(e){const n=new FormData;n.append("file",e);const{data:o,error:i}=await t.functions.invoke("upload-file",{body:n});if(i)throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${i.message}`);const a=o.data||o;if(a.error)throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${a.error}`);return a.fileId}async function z(e){if(!e||0===e.length)return;const{error:n}=await t.functions.invoke("delete-files",{body:JSON.stringify({fileIds:e})});n&&console.error("ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:",n.message)}async function U(e,n,o={}){const{isNested:a=!1,isDirectReply:s=!1,replyCountsMap:r=new Map,userCache:d=new Map}=o;if(!e)return null;const l=n||e.author;if(!l)return null;const c=e.repost_to&&!e.content;if(c){const t=l,n=e.reposted_post;if(!n){const n=document.createElement("div");n.className="post",n.dataset.postId=e.id;const o=document.createElement("div");o.className="post-main";const i=document.createElement("div");i.className="repost-indicator",i.innerHTML=`${y.repost}`;const a=document.createElement("a");a.href=`#profile/${t.id}`,a.textContent=t.name;const s=document.createElement("span");s.textContent=" ã•ã‚“ãŒãƒªãƒã‚¹ãƒˆã—ã¾ã—ãŸ",i.appendChild(a),i.appendChild(s),o.appendChild(i);const r=document.createElement("div");return r.className="deleted-post-container",r.textContent="ã“ã®ãƒã‚¹ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚",o.appendChild(r),n.appendChild(o),n}const s=await U(n,n.author,{...o,isNested:!1});if(!s)return null;s.dataset.postId=e.id,s.dataset.actionTargetId=n.id;const r=s.querySelector(".post-main");if(r){const n=document.createElement("div");n.className="repost-indicator",n.innerHTML=`${y.repost}`;const o=document.createElement("a");o.href=`#profile/${t.id}`,o.textContent=t.name;const s=document.createElement("span");s.textContent=" ã•ã‚“ãŒãƒªãƒã‚¹ãƒˆã—ã¾ã—ãŸ",n.appendChild(o),n.appendChild(s),r.prepend(n);const d=r.querySelector(".post-header");if(d&&(d.querySelector(".post-menu-btn")?.remove(),d.querySelector(".post-menu")?.remove(),i&&!a&&(i.id===e.userid||i.admin))){const e=document.createElement("button");e.className="post-menu-btn",e.innerHTML="â€¦";const t=document.createElement("div");t.className="post-menu";const n=document.createElement("button");n.className="delete-btn",n.textContent="ãƒªãƒã‚¹ãƒˆã‚’å‰Šé™¤",t.appendChild(n),d.appendChild(e),d.appendChild(t)}}return s}if(!n)return null;const m=document.createElement("div");m.className="post",m.dataset.postId=e.id,m.dataset.actionTargetId=e.id;const p=document.createElement("a");p.href=`#profile/${l.id}`,p.className="user-icon-link";const u=document.createElement("img");u.src=M(l),u.className="user-icon",u.alt=`${l.name}'s icon`,p.appendChild(u),m.appendChild(p);const g=document.createElement("div");if(g.className="post-main",!s)if(e.reply_to_post&&e.reply_to_post.author){const t=document.createElement("div");t.className="replying-to";const n=document.createElement("a");n.href=`#profile/${e.reply_to_post.author.id}`,n.textContent=`@${e.reply_to_post.author.name}`;const o=document.createElement("span");o.textContent=" ã•ã‚“ã«è¿”ä¿¡",t.appendChild(n),t.appendChild(o),g.appendChild(t)}else if(e.reply_to_user_id&&e.reply_to_user_name){const t=document.createElement("div");t.className="replying-to";const n=document.createElement("a");n.href=`#profile/${e.reply_to_user_id}`,n.textContent=`@${e.reply_to_user_name}`;const o=document.createElement("span");o.textContent=" ã•ã‚“ã«è¿”ä¿¡",t.appendChild(n),t.appendChild(o),g.appendChild(t)}const f=document.createElement("div");f.className="post-header";const h=document.createElement("a");if(h.href=`#profile/${l.id}`,h.className="post-author",h.textContent=l.name||"ä¸æ˜",f.appendChild(h),l.admin){const e=document.createElement("img");e.src="icons/admin.png",e.className="admin-badge",e.title="NyaXTeam",h.appendChild(e)}else if(l.verify){const e=document.createElement("img");e.src="icons/verify.png",e.className="verify-badge",e.title="èªè¨¼æ¸ˆã¿",h.appendChild(e)}const v=document.createElement("span");if(v.className="post-time",v.textContent=`#${l.id||"????"} Â· ${new Date(e.time).toLocaleString("ja-JP")}`,f.appendChild(v),i&&!a&&(i.id===e.userid||i.admin)){const t=document.createElement("button");t.className="post-menu-btn",t.innerHTML="â€¦";const n=document.createElement("div");if(n.className="post-menu",!e.repost_to||e.content){const e=document.createElement("button");e.className="edit-btn",e.textContent="ç·¨é›†",n.appendChild(e)}const o=document.createElement("button");o.className="delete-btn",o.textContent="å‰Šé™¤",n.appendChild(o),f.appendChild(t),f.appendChild(n)}if(g.appendChild(f),e.content){const t=document.createElement("div");t.className="post-content",t.innerHTML=L(e.content,d),g.appendChild(t)}if(e.attachments&&e.attachments.length>0){const n=document.createElement("div");n.className="attachments-container";for(const o of e.attachments){const{data:e}=t.storage.from("nyax").getPublicUrl(o.id),i=e.publicUrl,a=document.createElement("div");if(a.className="attachment-item","image"===o.type){const e=document.createElement("img");e.src=i,e.alt=o.name,e.className="attachment-image",e.onclick=e=>{e.stopPropagation(),window.openImageModal(i)},a.appendChild(e)}else if("video"===o.type){const e=document.createElement("video");e.src=i,e.controls=!0,e.onclick=e=>{e.stopPropagation()},a.appendChild(e)}else if("audio"===o.type){const e=document.createElement("audio");e.src=i,e.controls=!0,e.onclick=e=>{e.stopPropagation()},a.appendChild(e)}else{const e=document.createElement("a");e.href="#",e.className="attachment-download-link",e.textContent=`ğŸ“„ ${o.name}`,e.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.handleDownload(i,o.name)},a.appendChild(e)}n.appendChild(a)}g.appendChild(n)}if(e.repost_to&&e.content){const t=document.createElement("div");if(t.className="nested-repost-container",e.reposted_post){const n=await U(e.reposted_post,e.reposted_post.author,{...o,isNested:!0});n&&t.appendChild(n)}else{const e=document.createElement("div");e.className="deleted-post-container",e.textContent="ã“ã®ãƒã‚¹ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚",t.appendChild(e)}g.appendChild(t)}if(i&&!a){const t=document.createElement("div");t.className="post-actions";const o=c&&e.reposted_post?e.reposted_post:e;if(o){const e=r.get(o.id)||0,a=o.like||0,s=o.star||0,d=o.repost_count||0,l=document.createElement("button");l.className="reply-button",l.dataset.username=_(o.user?.name||n.name),l.innerHTML=`${y.reply} <span>${e}</span>`,t.appendChild(l);const c=document.createElement("button");c.className="like-button "+(i.like?.includes(o.id)?"liked":""),c.innerHTML=`${y.likes} <span>${a}</span>`,t.appendChild(c);const m=document.createElement("button");m.className="star-button "+(i.star?.includes(o.id)?"starred":""),m.innerHTML=`${y.stars} <span>${s}</span>`,t.appendChild(m);const p=document.createElement("button");p.className="repost-button",p.innerHTML=`${y.repost} <span>${d}</span>`,t.appendChild(p)}g.appendChild(t)}return m.appendChild(g),m}async function W(){if(!i)return v.pageHeader.innerHTML='<h2 id="page-title">é€šçŸ¥</h2>',b("notifications-screen"),v.notificationsContent.innerHTML='<p style="padding: 2rem; text-align:center; color: var(--secondary-text-color);">é€šçŸ¥ã‚’è¦‹ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>',void w(!1);v.pageHeader.innerHTML='\n            <div class="header-with-action-button">\n                <h2 id="page-title">é€šçŸ¥</h2>\n                <button id="mark-all-read-btn" class="header-action-btn">ã™ã¹ã¦æ—¢èª­</button>\n            </div>',b("notifications-screen");const e=v.notificationsContent;e.innerHTML='<div class="spinner"></div>',document.getElementById("mark-all-read-btn").addEventListener("click",(async()=>{if(confirm("ã™ã¹ã¦ã®é€šçŸ¥ã‚’æ—¢èª­ã«ã—ã¾ã™ã‹ï¼Ÿ")){w(!0);try{const{error:e}=await t.rpc("mark_all_notifications_as_read",{p_user_id:i.id});if(e)throw e;i.notice&&i.notice.forEach((e=>e.click=!0)),i.notice_count=0,await W(),await C()}catch(e){console.error("ã™ã¹ã¦æ—¢èª­å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:",e),alert("å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")}finally{w(!1)}}}));try{if(i.notice_count>0){const e=i.notice_count;i.notice_count=0,C(),t.from("user").update({notice_count:0}).eq("id",i.id).then((({error:t})=>{t?(console.error("Failed to reset notice_count:",t),i.notice_count=e,C()):localStorage.setItem("currentUser",JSON.stringify(i))}))}const n=new Set;(i.notice||[]).forEach((e=>{const t="object"==typeof e?e.message:e,o=/@(\d+)/g;let i;for(;null!==(i=o.exec(t));)n.add(parseInt(i[1]))}));const o=[...n].filter((e=>!u.has(e)));if(o.length>0){const{data:e}=await t.from("user").select("id, name, scid, icon_data").in("id",o);e&&e.forEach((e=>u.set(e.id,e)))}if(e.innerHTML="",i.notice?.length){const{data:n,error:o}=await t.from("user").select("notice").eq("id",i.id).single();if(o)throw o;i.notice=n.notice,i.notice.forEach((t=>{const n="object"==typeof t&&null!==t?t:{id:crypto.randomUUID(),message:t,open:"",click:!0},o=document.createElement("div");o.className="widget-item notification-item",n.click||o.classList.add("notification-new"),o.dataset.notificationId=n.id;const i=document.createElement("div");i.className="notification-item-content",i.innerHTML=L(n.message,u);const a=document.createElement("button");a.className="notification-delete-btn",a.innerHTML="Ã—",a.title="é€šçŸ¥ã‚’å‰Šé™¤",o.appendChild(i),o.appendChild(a),e.appendChild(o)}))}else e.innerHTML='<p style="padding: 2rem; text-align:center; color: var(--secondary-text-color);">é€šçŸ¥ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}catch(t){console.error("é€šçŸ¥ç”»é¢ã‚¨ãƒ©ãƒ¼:",t),e.innerHTML='<p class="error-message">é€šçŸ¥ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>'}finally{w(!1)}}async function j(e=null){if(!i)return k();b("dm-screen");const n=v.dmContent;if(e)v.pageHeader.innerHTML="",n.innerHTML='<div id="dm-conversation-container"></div>',await async function(e){const n=document.getElementById("dm-conversation-container");n.innerHTML='<div class="spinner"></div>';let o=[];try{const{data:a,error:s}=await t.from("dm").select("id, title, post, member, host_id").eq("id",e).single();if(s||!a||!a.member.includes(i.id))return v.pageHeader.innerHTML=`\n                    <div class="header-with-back-button">\n                        <button class="header-back-btn" onclick="window.history.back()">${y.back}</button>\n                        <h2 id="page-title">ã‚¨ãƒ©ãƒ¼</h2>\n                    </div>`,n.innerHTML='<p class="error-message" style="margin:2rem;">DMãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>',void w(!1);v.pageHeader.innerHTML=`\n                <div class="header-with-back-button">\n                    <button class="header-back-btn" onclick="window.history.back()">${y.back}</button>\n                    <div style="flex-grow:1;">\n                        <h2 id="page-title" style="font-size: 1.1rem; margin-bottom: 0;">${_(a.title)}</h2>\n                        <small style="color: var(--secondary-text-color);">${a.member.length}äººã®ãƒ¡ãƒ³ãƒãƒ¼</small>\n                    </div>\n                    <button class="dm-manage-btn" style="font-size: 1.2rem;" onclick="window.openDmManageModal('${a.id}')">â€¦</button>\n                </div>\n            `;const r=a.post||[],d=new Set(a.member),l=/@(\d+)/g;r.forEach((e=>{if(e.userid&&d.add(e.userid),e.content){let t;for(;null!==(t=l.exec(e.content));)d.add(parseInt(t[1]))}}));const c=[...d].filter((e=>e&&!u.has(e)));if(c.length>0){const{data:e}=await t.from("user").select("id, name, scid, icon_data").in("id",c);e&&e.forEach((e=>u.set(e.id,e)))}const g=r.slice().reverse().map($).join("");n.innerHTML=`\n                <div class="dm-conversation-view">${g}</div>\n                <div class="dm-message-form">\n                    <div class="dm-form-content">\n                        <textarea id="dm-message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"></textarea>\n                        <div class="file-preview-container dm-file-preview"></div>\n                    </div>\n                    <div class="dm-form-actions">\n                        <button id="dm-attachment-btn" class="attachment-button" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜">${y.attachment}</button>\n                        <input type="file" id="dm-file-input" class="hidden" multiple>\n                        <button id="send-dm-btn" title="é€ä¿¡ (Ctrl+Enter)">${y.send}</button>\n                    </div>\n                </div>\n            `,await t.rpc("mark_all_dm_messages_as_read",{p_dm_id:e,p_user_id:i.id}),await C();const f=document.getElementById("dm-message-input"),h=document.getElementById("dm-file-input"),b=n.querySelector(".file-preview-container");document.getElementById("dm-attachment-btn").onclick=()=>h.click(),h.onchange=e=>{o=Array.from(e.target.files),b.innerHTML="",o.forEach(((e,t)=>{const n=document.createElement("div");if(n.className="file-preview-item",e.type.startsWith("image/")){const o=new FileReader;o.onload=o=>{n.innerHTML=`<img src="${o.target.result}" alt="${e.name}"><button class="file-preview-remove" data-index="${t}">Ã—</button>`},o.readAsDataURL(e)}else if(e.type.startsWith("video/")){const o=new FileReader;o.onload=e=>{n.innerHTML=`<video src="${e.target.result}" style="width:100px; height:100px; object-fit:cover;" controls></video><button class="file-preview-remove" data-index="${t}">Ã—</button>`},o.readAsDataURL(e)}else if(e.type.startsWith("audio/")){const o=new FileReader;o.onload=e=>{n.innerHTML=`<div style="display:flex; align-items:center; gap:0.5rem;"><audio src="${e.target.result}" controls style="height: 30px; width: 200px;"></audio><button class="file-preview-remove" data-index="${t}" style="position:relative; top:0; right:0;">Ã—</button></div>`},o.readAsDataURL(e)}else n.innerHTML=`<span>ğŸ“„ ${_(e.name)}</span><button class="file-preview-remove" data-index="${t}">Ã—</button>`;b.appendChild(n)}))},b.addEventListener("click",(e=>{if(e.target.classList.contains("file-preview-remove")){const t=parseInt(e.target.dataset.index);o.splice(t,1);const n=new DataTransfer;o.forEach((e=>n.items.add(e))),h.files=n.files,h.dispatchEvent(new Event("change"))}}));const M=()=>{(async function(e,n=[]){const o=document.getElementById("dm-message-input"),a=o.value.trim();if(!a&&0===n.length)return;const s=document.getElementById("send-dm-btn");o.disabled=!0,s.disabled=!0;try{const s=/@(\d+)/g,r=new Set;let d;for(;null!==(d=s.exec(a));)r.add(parseInt(d[1]));const l=[...r].filter((e=>!u.has(e)));if(l.length>0){const{data:e}=await t.from("user").select("id, name, scid, icon_data").in("id",l);e&&e.forEach((e=>u.set(e.id,e)))}let c=[];if(n.length>0){w(!0);for(const e of n){const t=await R(e),n=e.type.startsWith("image/")?"image":e.type.startsWith("video/")?"video":e.type.startsWith("audio/")?"audio":"file";c.push({type:n,id:t,name:e.name})}w(!1)}const m={id:crypto.randomUUID(),time:(new Date).toISOString(),userid:i.id,content:a,attachments:c,read:[i.id]},{error:g}=await t.rpc("append_to_dm_post",{dm_id_in:e,new_message_in:m});if(g)throw g;{o.value="";const e=document.querySelector(".dm-conversation-view");if(e){const t=$(m);e.insertAdjacentHTML("afterbegin",t),p=m.id,e.scrollTop=e.scrollHeight}}}catch(e){alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),console.error(e)}finally{o.disabled=!1,s.disabled=!1,o.focus()}})(e,o).then((()=>{o=[],h.value="",b.innerHTML=""}))};f.addEventListener("keydown",(e=>{e.ctrlKey&&"Enter"===e.key&&(e.preventDefault(),M())})),document.getElementById("send-dm-btn").onclick=M,p=r.length>0?r[r.length-1].id:null,m&&t.removeChannel(m),m=t.channel(`dm-${e}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"dm",filter:`id=eq.${e}`},(async n=>{const o=n.new.post;if(!o||0===o.length)return;const a=o[o.length-1];if(a.id===p||a.userid===i.id)return;const s=document.querySelector(".dm-conversation-view");if(s){const n=$(a);s.insertAdjacentHTML("afterbegin",n),p=a.id,await t.rpc("mark_all_dm_messages_as_read",{p_dm_id:e,p_user_id:i.id})}})).subscribe()}catch(e){console.error("DMä¼šè©±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:",e),n.innerHTML='<p class="error-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>'}finally{w(!1)}}(e);else{v.pageHeader.innerHTML='<h2 id="page-title">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>',n.innerHTML='\n                <div id="dm-list-container">\n                    <button class="dm-new-message-btn" onclick="window.openCreateDmModal()">æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>\n                    <div id="dm-list-items-wrapper" class="spinner"></div>\n                </div>\n            ';const e=document.getElementById("dm-list-items-wrapper");try{const{data:n,error:o}=await t.from("dm").select("id, title, member, time").contains("member",[i.id]).order("time",{ascending:!1});if(o)throw o;const{data:a,error:s}=await t.rpc("get_all_unread_dm_counts",{p_user_id:i.id});if(s)throw s;const r=new Map(a.map((e=>[e.dm_id,e.unread_count]))),d=[...new Set(n.flatMap((e=>e.member)))].filter((e=>!u.has(e)));if(d.length>0){const{data:e}=await t.from("user").select("id, name, scid, icon_data").in("id",d);e&&e.forEach((e=>u.set(e.id,e)))}window.location.hash.startsWith("#dm/")&&window.history.replaceState({path:"#dm"},"","#dm"),0===n.length?e.innerHTML='<p style="text-align:center; padding: 2rem; color: var(--secondary-text-color);">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>':e.innerHTML=n.map((e=>{const t=r.get(e.id)||0,n=t>0?`(${t}) `:"",o=_(e.title)||e.member.map((e=>u.get(e)?.name||e)).join(", ");return`\n                            <div class="dm-list-item" onclick="window.location.hash='#dm/${e.id}'">\n                                <div class="dm-list-item-title">${n}${o}</div>\n                                <button class="dm-manage-btn" onclick="event.stopPropagation(); window.openDmManageModal('${e.id}')">â€¦</button>\n                            </div>\n                        `})).join(""),e.classList.remove("spinner")}catch(t){console.error("DMãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:",t),e.innerHTML='<p class="error-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>',e.classList.remove("spinner")}finally{w(!1)}}}async function O(e,o){const a=document.getElementById("profile-header"),s=document.getElementById("profile-tabs"),r=document.getElementById("profile-content");g=!1,n&&n.disconnect(),r.innerHTML="";const d="following"===o||"followers"===o;a.classList.toggle("hidden",d),s.classList.toggle("hidden",d);const l=document.getElementById("page-title-main"),c=document.getElementById("page-title-sub");l.textContent=e.name,c.textContent=d?`#${e.id}`:"media"===o?`${e.mediaCount||0} ä»¶ã®ç”»åƒã¨å‹•ç”»`:`${e.postCount||0} ä»¶ã®ãƒã‚¹ãƒˆ`;const m=document.getElementById("profile-sub-tabs-container");if(m&&m.remove(),d){const t=document.createElement("div");t.id="profile-sub-tabs-container",t.innerHTML=`\n                <div class="profile-sub-tabs">\n                    <button class="tab-button ${"following"===o?"active":""}" data-sub-tab="following">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>\n                    <button class="tab-button ${"followers"===o?"active":""}" data-sub-tab="followers">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</button>\n                </div>`,v.pageHeader.parentNode.insertBefore(t,v.pageHeader.nextSibling);const n=v.pageHeader.offsetHeight;t.style.top=`${n}px`,t.querySelectorAll(".tab-button").forEach((t=>{t.onclick=n=>{n.stopPropagation(),O(e,t.dataset.subTab)}}))}else document.querySelectorAll("#profile-tabs .tab-button").forEach((e=>e.classList.toggle("active",e.dataset.tab===o)));let p="posts"===o?`#profile/${e.id}`:`#profile/${e.id}/${o}`;window.location.hash!==p&&window.history.pushState({path:p},"",p);try{switch(o){case"posts":await F(r,"profile_posts",{userId:e.id,subType:"posts_only"});break;case"replies":await F(r,"profile_posts",{userId:e.id,subType:"replies_only"});break;case"likes":if(!(e.settings.show_like||i&&e.id===i.id)){r.innerHTML='<p style="padding: 2rem; text-align:center;">ğŸ”’ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã„ã„ã­ã¯éå…¬é–‹ã§ã™ã€‚</p>';break}await F(r,"likes",{ids:e.like||[]});break;case"stars":if(!(e.settings.show_star||i&&e.id===i.id)){r.innerHTML='<p style="padding: 2rem; text-align:center;">ğŸ”’ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠæ°—ã«å…¥ã‚Šã¯éå…¬é–‹ã§ã™ã€‚</p>';break}await F(r,"stars",{ids:e.star||[]});break;case"following":if(!(e.settings.show_follow||i&&e.id===i.id)){r.innerHTML='<p style="padding: 2rem; text-align:center;">ğŸ”’ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã¯éå…¬é–‹ã§ã™ã€‚</p>';break}await J(r,"follows",{ids:e.follow||[]});break;case"followers":if(!(e.settings.show_follower||i&&e.id===i.id)){r.innerHTML='<p style="padding: 2rem; text-align:center;">ğŸ”’ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªã‚¹ãƒˆã¯éå…¬é–‹ã§ã™ã€‚</p>';break}await J(r,"followers",{userId:e.id});break;case"media":await async function(e,o={}){f={page:0,hasMore:!0,type:"media",options:o};const i=document.createElement("div");i.className="media-grid-container",e.appendChild(i);let a=e.querySelector(".load-more-trigger");a&&a.remove();a=document.createElement("div"),a.className="load-more-trigger",e.appendChild(a);const s=15,r=async()=>{if(g||!f.hasMore)return;g=!0,a.innerHTML='<div class="spinner"></div>';const e=f.page*s,r=e+s-1,{data:d,error:l}=await t.rpc("get_user_media",{p_user_id:o.userId}).range(e,r);if(l)console.error("ãƒ¡ãƒ‡ã‚£ã‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:",l),a.innerHTML="èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";else{if(d&&d.length>0){for(const e of d){const{data:n}=t.storage.from("nyax").getPublicUrl(e.file_id),o=document.createElement("a");o.href=`#post/${e.post_id}`,o.className="media-grid-item","image"===e.file_type?o.innerHTML=`<img src="${n.publicUrl}" loading="lazy" alt="æŠ•ç¨¿ãƒ¡ãƒ‡ã‚£ã‚¢">`:"video"===e.file_type&&(o.innerHTML=`<video src="${n.publicUrl}" muted playsinline loading="lazy"></video>`),i.appendChild(o)}f.page++,d.length<s&&(f.hasMore=!1)}else f.hasMore=!1;f.hasMore?a.innerHTML="":(a.innerHTML=i.hasChildNodes()?"":"ãƒ¡ãƒ‡ã‚£ã‚¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",n&&n.unobserve(a))}g=!1};n=new IntersectionObserver((e=>{e[0].isIntersecting&&!g&&r()}),{rootMargin:"200px"}),n.observe(a)}(r,{userId:e.id})}}catch(e){r.innerHTML='<p class="error-message">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>',console.error("loadProfileTabContent error:",e)}}async function F(e,n,o={}){let a;f={page:0,hasMore:!0,type:n,options:o};const s=document.createElement("div");s.className="load-more-trigger",e.appendChild(s);const r=async()=>{if(g||!f.hasMore)return;const s=e.querySelector(".load-more-trigger");if(s){g=!0,s.innerHTML='<div class="spinner"></div>';try{let a=[],r=!0;if("timeline"===n&&"foryou"===o.tab||"search"===n){const e="search"===n?"search_posts":"get_recommended_posts",s="search"===n?{query:o.query,page_size:h,page_num:f.page}:{p_user_id:i?.id||null,page_size:h,page_num:f.page},{data:d,error:l}=await t.rpc(e,s);if(l)throw l;a=d||[],a.length<h&&(r=!1)}else{const e=f.page*h,s=e+h-1;let d,l=[];if("timeline"===n)d=t.from("post").select("id").is("reply_id",null),"following"===o.tab&&(i?.follow?.length>0?d=d.in("userid",i.follow):r=!1);else if("profile_posts"===n)o.userId?(d=t.from("post").select("id").eq("userid",o.userId),"posts_only"===o.subType?d=d.is("reply_id",null):"replies_only"===o.subType&&(d=d.not("reply_id","is",null))):r=!1;else if("likes"===n||"stars"===n){l=(o.ids||[]).slice(e,s+1),l.length<h&&(r=!1)}if(d&&r){const{data:t,error:n}=await d.order("time",{ascending:!1}).range(e,s);if(n)throw n;l=t.map((e=>e.id)),t.length<h&&(r=!1)}if(l.length>0){const{data:e,error:n}=await t.rpc("get_hydrated_posts",{p_post_ids:l});if(n)throw n;const o=new Map(l.map(((e,t)=>[e,t])));a=e.sort(((e,t)=>o.get(e.id)-o.get(t.id)))}}if(!e.querySelector(".load-more-trigger"))return;if(a&&a.length>0){if(f.page>0){const e=function(){const e=document.createElement("div");e.className="post ad-post",e.innerHTML='\n            <div class="user-icon-link">\n                <img src="favicon.png" class="user-icon" alt="åºƒå‘Šã‚¢ã‚¤ã‚³ãƒ³">\n            </div>\n            <div class="post-main">\n                <div class="post-header">\n                    <span class="post-author">[åºƒå‘Š]</span>\n                </div>\n                <div class="post-content">\n                    <iframe scrolling="no" frameborder="0" style="width:300px; height:250px; border:0; overflow:hidden;"></iframe>\n                </div>\n            </div>\n        ';const t=e.querySelector("iframe");return t.onload=()=>{const e=t.contentWindow.document;e.open(),e.write('\n                <body style="margin:0; padding:0;">\n                    \x3c!-- admax --\x3e\n                    <div class="admax-ads" data-admax-id="0bd891d69fb4e13cd644500a25fc1f46" style="display:inline-block;width:300px;height:250px;"></div>\n                    <script type="text/javascript">(admaxads = window.admaxads || []).push({admax_id: "0bd891d69fb4e13cd644500a25fc1f46",type: "banner"});<\/script>\n                    <script type="text/javascript" charset="utf-8" src="https://adm.shinobi.jp/st/t.js" async><\/script>\n                    \x3c!-- admax --\x3e\n                </body>\n            '),e.close()},e.addEventListener("click",(e=>{e.stopPropagation()}),!0),e}();e&&s.before(e)}const e=a.map((e=>e.repost_to&&!e.content&&e.reposted_post?e.reposted_post.id:e.id)).filter((e=>e)),[{data:n},{data:o},{data:i},{data:r}]=await Promise.all([t.rpc("get_reply_counts",{post_ids:e}),t.rpc("get_like_counts_for_posts",{p_post_ids:e}),t.rpc("get_star_counts_for_posts",{p_post_ids:e}),t.rpc("get_repost_counts_for_posts",{p_post_ids:e})]),d=new Map(n.map((e=>[e.post_id,e.reply_count]))),l=new Map(o.map((e=>[e.post_id,e.like_count]))),c=new Map(i.map((e=>[e.post_id,e.star_count]))),m=new Map(r.map((e=>[e.post_id,e.repost_count])));for(const e of a){const t=e.repost_to&&!e.content?e.reposted_post:e;t&&(t.like=l.get(t.id)||0,t.star=c.get(t.id)||0,t.repost_count=m.get(t.id)||0);const n=await U(e,e.author,{replyCountsMap:d,userCache:u});n&&s.before(n)}}f.page++,f.hasMore=r}catch(e){console.error("ãƒã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:",e),s&&(s.innerHTML="ãƒã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),f.hasMore=!1,a&&a.disconnect()}finally{g=!1;const t=e.querySelector(".load-more-trigger");if(!t)return;const i={timeline:"ã¾ã ãƒã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚",profile_posts:"ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã¾ã ãƒã‚¹ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚",replies:"ã¾ã è¿”ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",search:"è©²å½“ã™ã‚‹ãƒã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",likes:"ã„ã„ã­ã—ãŸãƒã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",stars:"ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸãƒã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"},s="replies_only"===o.subType?"replies":n;f.hasMore?t.innerHTML.includes("spinner")&&(t.innerHTML=""):(t.innerHTML=0===e.querySelectorAll(".post").length?i[s]||"":"ã™ã¹ã¦ã®ãƒã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ",a&&a.disconnect())}}else a&&a.disconnect()};a=new IntersectionObserver((e=>{e[0].isIntersecting&&!g&&r()}),{rootMargin:"200px"}),a.observe(s)}async function J(e,o,i={}){f={page:0,hasMore:!0,type:o,options:i};let a=e.querySelector(".load-more-trigger");a&&a.remove(),a=document.createElement("div"),a.className="load-more-trigger",e.appendChild(a);const s=async()=>{if(g||!f.hasMore)return;g=!0,a.innerHTML='<div class="spinner"></div>';const s=f.page*h,r=s+h-1;let d=[],l=null;if("follows"===o){const e=(i.ids||[]).slice(s,r+1);if(e.length>0){const n=await t.from("user").select("id, name, me, scid, icon_data, admin, verify").in("id",e);d=n.data,l=n.error}}else if("followers"===o){const e=await t.rpc("get_followers",{target_user_id:i.userId}).range(s,r);d=e.data,l=e.error}if(l)console.error(`${o}ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã«å¤±æ•—:`,l),a.innerHTML="èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";else if(d&&d.length>0?(d.forEach((t=>e.insertBefore((e=>{const t=document.createElement("div");t.className="profile-card widget-item";const n=document.createElement("a");n.href=`#profile/${e.id}`,n.className="profile-link",n.style.cssText="display:flex; align-items:center; gap:0.8rem; text-decoration:none; color:inherit;";const o=e.admin?' <img src="icons/admin.png" class="admin-badge" title="NyaXTeam">':e.verify?' <img src="icons/verify.png" class="verify-badge" title="èªè¨¼æ¸ˆã¿">':"";return n.innerHTML=`\n                <img src="${M(e)}" style="width:48px; height:48px; border-radius:50%;" alt="${e.name}'s icon">\n                <div>\n                    <span class="name" style="font-weight:700;">${_(e.name)}${o}</span>\n                    <span class="id" style="color:var(--secondary-text-color);">#${e.id}</span>\n                    <p class="me" style="margin:0.2rem 0 0;">${_(e.me||"")}</p>\n                </div>`,t.appendChild(n),t})(t),a))),f.page++,d.length<h&&(f.hasMore=!1)):f.hasMore=!1,f.hasMore)a.innerHTML="";else{const t={follows:"èª°ã‚‚ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã¾ã›ã‚“ã€‚",followers:"ã¾ã ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚"};a.innerHTML=0===e.querySelectorAll(".profile-card").length?t[o]:"ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ",n&&n.unobserve(a)}g=!1};n=new IntersectionObserver((e=>{e[0].isIntersecting&&!g&&s()}),{rootMargin:"200px"}),n.observe(a)}async function X(e){("following"!==e||i)&&(g=!1,s=e,document.querySelectorAll(".timeline-tab-button").forEach((t=>t.classList.toggle("active",t.dataset.tab===e))),n&&n.disconnect(),v.timeline.innerHTML="",await F(v.timeline,"timeline",{tab:e}))}async function V(e){if(e.preventDefault(),!i)return;const n=e.target,o=n.querySelector('button[type="submit"]');o.disabled=!0,w(!0);try{const e={name:n.querySelector("#setting-username").value.trim(),me:n.querySelector("#setting-me").value.trim(),settings:{show_like:n.querySelector("#setting-show-like").checked,show_follow:n.querySelector("#setting-show-follow").checked,show_follower:n.querySelector("#setting-show-follower").checked,show_star:n.querySelector("#setting-show-star").checked,show_scid:n.querySelector("#setting-show-scid").checked,default_timeline_tab:n.querySelector("#setting-default-timeline").value}};if(!e.name)throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¿…é ˆã§ã™ã€‚");if(c)i.icon_data&&!i.icon_data.startsWith("data:image")&&await z([i.icon_data]),e.icon_data=null;else if(l){i.icon_data&&!i.icon_data.startsWith("data:image")&&await z([i.icon_data]);const t=await(await fetch(l)).blob(),n=await R(new File([t],"icon.png",{type:t.type}));e.icon_data=n}else if(i.icon_data&&i.icon_data.startsWith("data:image")){const t=await(await fetch(i.icon_data)).blob(),n=await R(new File([t],"icon.png",{type:t.type}));e.icon_data=n}const{data:o,error:a}=await t.from("user").update(e).eq("id",i.id).select().single();if(a)throw a;alert("è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚"),i=o,l=null,c=!1,window.location.hash=""}catch(e){console.error("è¨­å®šã®æ›´æ–°ã«å¤±æ•—:",e),alert(`è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`)}finally{o.disabled=!1,w(!1)}}async function Z(e){w(!0);try{const{data:n,error:o}=await t.from("post").select("content, attachments").eq("id",e).single();if(o||!n)throw new Error("ãƒã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");let a=n.attachments||[],s=new Set,r=[];const d=()=>{let e="";a.forEach(((t,n)=>{s.has(t.id)||(e+=`\n                        <div class="file-preview-item">\n                            <span>${"image"===t.type?"ğŸ–¼ï¸":"ğŸ“"} ${_(t.name)}</span>\n                            <button class="file-preview-remove" data-id="${t.id}" data-type="existing">Ã—</button>\n                        </div>`)}));let t="";return r.forEach(((e,n)=>{t+=`\n                        <div class="file-preview-item">\n                            <span>${e.type.startsWith("image/")?"ğŸ–¼ï¸":"ğŸ“"} ${_(e.name)}</span>\n                            <button class="file-preview-remove" data-index="${n}" data-type="new">Ã—</button>\n                        </div>`})),e+t},l=()=>{const e=v.editPostModalContent.querySelector(".file-preview-container");e&&(e.innerHTML=d())};v.editPostModalContent.innerHTML=`\n                <div class="post-form" style="padding: 1rem;">\n                    <img src="${M(i)}" class="user-icon" alt="your icon">\n                    <div class="form-content">\n                        <textarea id="edit-post-textarea" class="post-form-textarea">${n.content}</textarea>\n                        <div class="file-preview-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">${d()}</div>\n                        <div class="post-form-actions" style="padding-top: 1rem;">\n                            <button type="button" class="attachment-button" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ">${y.attachment}</button>\n                            <input type="file" id="edit-file-input" class="hidden" multiple>\n                            <button id="update-post-button" style="padding: 0.5rem 1.5rem; border-radius: 9999px; border: none; background-color: var(--primary-color); color: white; font-weight: 700; margin-left: auto;">ä¿å­˜</button>\n                        </div>\n                    </div>\n                </div>\n            `,v.editPostModal.querySelector("#update-post-button").onclick=()=>K(e,a,r,Array.from(s)),v.editPostModal.querySelector(".modal-close-btn").onclick=()=>v.editPostModal.classList.add("hidden"),v.editPostModal.querySelector(".attachment-button").onclick=()=>{v.editPostModal.querySelector("#edit-file-input").click()},v.editPostModal.querySelector("#edit-file-input").onchange=e=>{r.push(...Array.from(e.target.files)),l()},v.editPostModal.querySelector(".file-preview-container").onclick=e=>{if(e.target.classList.contains("file-preview-remove")){const t=e.target.dataset.type;if("existing"===t)s.add(e.target.dataset.id);else if("new"===t){const t=parseInt(e.target.dataset.index);r.splice(t,1)}l()}},v.editPostModal.classList.remove("hidden"),v.editPostModal.querySelector("#edit-post-textarea").focus()}catch(e){console.error(e),alert(e.message)}finally{w(!1)}}async function Y(e,n){const o=/@(\d+)/g,i=new Set;let a;for(;null!==(a=o.exec(n));)i.add(parseInt(a[1]));const s=[...i].filter((e=>!u.has(e)));if(s.length>0){const{data:e}=await t.from("user").select("id, name, scid, icon_data").in("id",s);e&&e.forEach((e=>u.set(e.id,e)))}const r={id:crypto.randomUUID(),time:(new Date).toISOString(),type:"system",content:n};await t.rpc("append_to_dm_post",{dm_id_in:e,new_message_in:r})}async function K(e,n,o,i){const a=v.editPostModal.querySelector("#edit-post-textarea").value.trim();v.editPostModal.querySelector("#edit-post-textarea").addEventListener("keydown",(t=>{t.ctrlKey&&"Enter"===t.key&&(t.preventDefault(),K(e,n,o,i))}));const s=v.editPostModal.querySelector("#update-post-button");s.disabled=!0,s.textContent="ä¿å­˜ä¸­...",w(!0);try{i.length>0&&await z(i);let s=[];if(o.length>0)for(const e of o){const t=await R(e),n=e.type.startsWith("image/")?"image":e.type.startsWith("video/")?"video":e.type.startsWith("audio/")?"audio":"file";s.push({type:n,id:t,name:e.name})}let r=n.filter((e=>!i.includes(e.id)));r.push(...s);const{error:d}=await t.from("post").update({content:a,attachments:r.length>0?r:null}).eq("id",e);if(d)throw d;v.editPostModal.classList.add("hidden"),k()}catch(e){console.error(e),alert("ãƒã‚¹ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{s.disabled=!1,s.textContent="ä¿å­˜",w(!1)}}async function G(e){if(!i)return;const n=[i.id,e].sort(((e,t)=>e-t)),{data:o}=await t.from("dm").select("id").contains("member",n).eq("member",`{${n.join(",")}}`).single();if(o)window.location.hash=`#dm/${o.id}`;else{const{data:o}=await t.from("user").select("name").eq("id",e).single();if(confirm(`${o.name}ã•ã‚“ã¨ã®æ–°ã—ã„DMã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)){w(!0);try{const{data:a,error:s}=await t.from("dm").insert({host_id:i.id,member:n,title:`${i.name}, ${o.name}`}).select("id").single();if(s)throw s;await E(e,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã‚’DMã«æ‹›å¾…ã—ã¾ã—ãŸã€‚`,`#dm/${a.id}`),window.location.hash=`#dm/${a.id}`}catch(e){alert("DMã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),console.error(e)}finally{w(!1)}}}}async function Q(e,n){w(!0);try{const{data:o,error:i}=await t.from("dm").select("post").eq("id",e).single();if(i||!o)throw new Error("DMæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");const a=(o.post||[]).find((e=>e.id===n));if(!a)throw new Error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");let s=a.attachments||[],r=new Set,d=[];const l=()=>s.filter((e=>!r.has(e.id))).map(((e,t)=>`\n                        <div class="file-preview-item">\n                            <span>${e.type.startsWith("image")?"ğŸ–¼ï¸":"ğŸ“"} ${_(e.name)}</span>\n                            <button class="file-preview-remove" data-id="${e.id}" data-type="existing">Ã—</button>\n                        </div>`)).join("")+d.map(((e,t)=>`\n                        <div class="file-preview-item">\n                            <span>${e.type.startsWith("image")?"ğŸ–¼ï¸":"ğŸ“"} ${_(e.name)}</span>\n                            <button class="file-preview-remove" data-index="${t}" data-type="new">Ã—</button>\n                        </div>`)).join(""),c=()=>{const e=v.editDmMessageModalContent.querySelector(".file-preview-container");e&&(e.innerHTML=l())};v.editDmMessageModalContent.innerHTML=`\n                <div class="post-form" style="padding: 1rem;">\n                    <div class="form-content">\n                        <textarea id="edit-dm-textarea" style="min-height: 100px; font-size: 1rem;">${a.content||""}</textarea>\n                        <div class="file-preview-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;"></div>\n                        <div class="post-form-actions" style="padding-top: 1rem;">\n                            <button type="button" class="attachment-button" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ">${y.attachment}</button>\n                            <input type="file" id="edit-dm-file-input" class="hidden" multiple>\n                            <button id="update-dm-message-button" style="padding: 0.5rem 1.5rem; border-radius: 9999px; border: none; background-color: var(--primary-color); color: white; font-weight: 700; margin-left: auto;">ä¿å­˜</button>\n                        </div>\n                    </div>\n                </div>`,c(),v.editDmMessageModal.querySelector("#update-dm-message-button").onclick=()=>async function(e,n,o,i,a){const s=v.editDmMessageModal.querySelector("#edit-dm-textarea").value.trim(),r=v.editDmMessageModal.querySelector("#update-dm-message-button");r.disabled=!0,r.textContent="ä¿å­˜ä¸­...",w(!0);try{a.length>0&&await z(a);let r=[];if(i.length>0)for(const e of i){const t=await R(e),n=e.type.startsWith("image/")?"image":e.type.startsWith("video/")?"video":e.type.startsWith("audio/")?"audio":"file";r.push({type:n,id:t,name:e.name})}const d=o.filter((e=>!a.includes(e.id)));d.push(...r);const{data:l,error:c}=await t.from("dm").select("post").eq("id",e).single();if(c)throw c;const m=l.post||[],p=m.findIndex((e=>e.id===n));if(-1===p)throw new Error("æ›´æ–°å¯¾è±¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");m[p].content=s,m[p].attachments=d;const{error:u}=await t.from("dm").update({post:m}).eq("id",e);if(u)throw u;v.editDmMessageModal.classList.add("hidden");const g=document.querySelector(`.dm-message-container[data-message-id="${n}"]`);g&&(g.outerHTML=$(m[p]))}catch(e){console.error(e),alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{r.disabled=!1,r.textContent="ä¿å­˜",w(!1)}}(e,n,s,d,Array.from(r)),v.editDmMessageModal.querySelector(".attachment-button").onclick=()=>v.editDmMessageModal.querySelector("#edit-dm-file-input").click(),v.editDmMessageModal.querySelector("#edit-dm-file-input").onchange=e=>{d.push(...Array.from(e.target.files)),c()},v.editDmMessageModal.querySelector(".file-preview-container").onclick=e=>{if(e.target.classList.contains("file-preview-remove")){const t=e.target.dataset.type;if("existing"===t)r.add(e.target.dataset.id);else if("new"===t){const t=parseInt(e.target.dataset.index);d.splice(t,1)}c()}},v.editDmMessageModal.classList.remove("hidden"),v.editDmMessageModal.querySelector(".modal-close-btn").onclick=()=>v.editDmMessageModal.classList.add("hidden")}catch(e){alert(e.message)}finally{w(!1)}}window.openImageModal=e=>{v.imagePreviewModalContent.src=e,v.imagePreviewModal.classList.remove("hidden")},window.closeImageModal=()=>{v.imagePreviewModal.classList.add("hidden"),v.imagePreviewModalContent.src=""},window.handleDownload=async(e,t)=>{try{const n=await fetch(e);if(!n.ok)throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");const o=await n.blob(),i=window.URL.createObjectURL(o),a=document.createElement("a");a.style.display="none",a.href=i,a.download=t,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(i),a.remove()}catch(e){console.error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:",e),alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}},window.deletePost=async e=>{if(confirm("ã“ã®ãƒã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){w(!0);try{const{data:n,error:o}=await t.from("post").select("attachments").eq("id",e).single();if(o)throw new Error(`ãƒã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—: ${o.message}`);if(n.attachments&&n.attachments.length>0){const e=n.attachments.map((e=>e.id));await z(e)}const{error:i}=await t.from("post").delete().eq("id",e);if(i)throw i;k()}catch(e){console.error(e),alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{w(!1)}}},window.handleReplyClick=(e,t)=>{if(!i)return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");q({id:e,name:t})},window.clearReply=()=>{r=null;const e=document.getElementById("reply-info");e&&e.classList.add("hidden")},window.handleLike=async(e,n)=>{if(!i)return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");e.disabled=!0;const o=e.querySelector("span:not(.icon)"),a=i.like?.includes(n),s=a?i.like.filter((e=>e!==n)):[...i.like||[],n],{error:r}=await t.from("user").update({like:s}).eq("id",i.id);if(r)return alert("ã„ã„ã­ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),void(e.disabled=!1);const d=parseInt(o.textContent);if(o.textContent=a?d-1:d+1,e.classList.toggle("liked",!a),i.like=s,localStorage.setItem("currentUser",JSON.stringify(i)),!a){const{data:e}=await t.from("post").select("userid, id").eq("id",n).single();e?.userid&&e.userid!==i.id&&E(e.userid,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã®ãƒã‚¹ãƒˆã«ã„ã„ã­ã—ã¾ã—ãŸã€‚`,`#post/${e.id}`)}e.disabled=!1},window.handleStar=async(e,n)=>{if(!i)return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");e.disabled=!0;const o=e.querySelector("span:not(.icon)"),a=i.star?.includes(n),s=a?i.star.filter((e=>e!==n)):[...i.star||[],n],{error:r}=await t.from("user").update({star:s}).eq("id",i.id);if(r)return alert("ãŠæ°—ã«å…¥ã‚Šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),void(e.disabled=!1);const d=parseInt(o.textContent);if(o.textContent=a?d-1:d+1,e.classList.toggle("starred",!a),i.star=s,localStorage.setItem("currentUser",JSON.stringify(i)),!a){const{data:e}=await t.from("post").select("userid, id").eq("id",n).single();e?.userid&&e.userid!==i.id&&E(e.userid,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã®ãƒã‚¹ãƒˆã‚’ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ã¾ã—ãŸã€‚`,`#post/${e.id}`)}e.disabled=!1},window.handleFollowToggle=async(e,n)=>{if(!i)return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");n.disabled=!0;const o=i.follow?.includes(e),a=o?i.follow.filter((t=>t!==e)):[...i.follow||[],e],{error:s}=await t.from("user").update({follow:a}).eq("id",i.id);if(s)alert("ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),n.disabled=!1;else{i.follow=a,x(n,!o),o||E(e,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸã€‚`,`#profile/${i.id}`);const s=document.querySelector("#follower-count strong");if(s){const{data:n,error:o}=await t.rpc("get_follower_count",{target_user_id:e});o?(console.error("ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã®å†å–å¾—ã«å¤±æ•—:",o),s.textContent="?"):s.textContent=n}}},window.openDmManageModal=async function(e){v.dmManageModalContent.innerHTML='<div class="spinner"></div>',v.dmManageModal.classList.remove("hidden"),v.dmManageModal.querySelector(".modal-close-btn").onclick=()=>v.dmManageModal.classList.add("hidden");try{const{data:n,error:o}=await t.from("dm").select("id, title, member, host_id").eq("id",e).single();if(o||!n)throw new Error("DMæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");const a=n.host_id===i.id,s=await Promise.all(n.member.map((async e=>u[e]||(await t.from("user").select("id, name").eq("id",e).single()).data)));let r='<div style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;"><h3>DMç®¡ç†</h3>';if(r+=a?`\n                    <div>\n                        <label for="dm-title-input" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">ã‚¿ã‚¤ãƒˆãƒ«</label>\n                        <input type="text" id="dm-title-input" value="${_(n.title||"")}" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px;">\n                        <button id="save-dm-title-btn" style="margin-top: 0.5rem;">ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¿å­˜</button>\n                    </div>\n                    <div>\n                        <h4 style="margin: 0 0 0.5rem 0;">ãƒ¡ãƒ³ãƒãƒ¼ (${n.member.length})</h4>\n                        <div id="dm-member-list">\n                            ${s.map((e=>`\n                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">\n                                    <span>${_(e.name)} (#${e.id}) ${e.id===n.host_id?"(ãƒ›ã‚¹ãƒˆ)":""}</span>\n                                    ${e.id!==n.host_id?`<button class="remove-member-btn" data-user-id="${e.id}" data-user-name="${_(e.name)}">å‰Šé™¤</button>`:""}\n                                </div>`)).join("")}\n                        </div>\n                    </div>\n                    <div>\n                        <label for="dm-add-member-search" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ </label>\n                        <input type="text" id="dm-add-member-search" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯IDã§æ¤œç´¢" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px;">\n                        <div id="dm-add-member-results" style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto;"></div>\n                    </div>\n                    <hr>\n                    <button id="disband-dm-btn" style="align-self: flex-end;">DMã‚’è§£æ•£</button>\n                `:'\n                    <p>ã“ã®DMã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ<br>ä¸€åº¦é€€å‡ºã™ã‚‹ã¨ã€å†åº¦æ‹›å¾…ã•ã‚Œãªã„é™ã‚Šå‚åŠ ã§ãã¾ã›ã‚“ã€‚</p>\n                    <button id="leave-dm-btn" style="align-self: flex-end;">DMã‹ã‚‰é€€å‡º</button>\n                ',r+="</div>",v.dmManageModalContent.innerHTML=r,a){document.getElementById("save-dm-title-btn").onclick=()=>async function(e,n){const{error:o}=await t.from("dm").update({title:n.trim()}).eq("id",e);o?alert("ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"):(alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚"),v.dmManageModal.classList.add("hidden"),j(e))}(e,document.getElementById("dm-title-input").value),document.getElementById("disband-dm-btn").onclick=()=>async function(e){if(!confirm("æœ¬å½“ã«ã“ã®DMã‚’è§£æ•£ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚"))return;w(!0);try{const{data:n,error:o}=await t.from("dm").select("post").eq("id",e).single();if(o)throw o;const i=(n.post||[]).flatMap((e=>e.attachments||[])).map((e=>e.id));i.length>0&&await z(i);const{error:a}=await t.from("dm").delete().eq("id",e);if(a)throw a;alert("DMã‚’è§£æ•£ã—ã¾ã—ãŸã€‚"),v.dmManageModal.classList.add("hidden"),window.location.hash="#dm",await j()}catch(e){console.error(e),alert("DMã®è§£æ•£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{w(!1)}}(e),document.querySelectorAll(".remove-member-btn").forEach((n=>{const o=parseInt(n.dataset.userId),a=n.dataset.userName;n.onclick=()=>async function(e,n,o){if(!confirm(`${o}ã•ã‚“ã‚’DMã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;const{data:a}=await t.from("dm").select("member").eq("id",e).single(),s=a.member.filter((e=>e!==n)),{error:r}=await t.from("dm").update({member:s}).eq("id",e);r?alert("ãƒ¡ãƒ³ãƒãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"):(await Y(e,`@${i.id}ã•ã‚“ãŒ@${n}ã•ã‚“ã‚’å¼·åˆ¶é€€å‡ºã•ã›ã¾ã—ãŸ`),E(n,`@${i.id}ã•ã‚“ã«ã‚ˆã£ã¦DMã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`),alert("ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"),openDmManageModal(e))}(e,o,a)}));const o=document.getElementById("dm-add-member-search"),a=document.getElementById("dm-add-member-results");let s;o.addEventListener("input",(()=>{clearTimeout(s),s=setTimeout((async()=>{const e=o.value.trim();if(e.length<2)return void(a.innerHTML="");const{data:i}=await t.from("user").select("id, name").or(`name.ilike.%${e}%,id.eq.${parseInt(e)||0}`).limit(5),s=i.filter((e=>!n.member.includes(e.id)));a.innerHTML=s.length>0?s.map((e=>`<div class="widget-item" style="cursor: pointer;" data-user-id="${e.id}"><strong>${_(e.name)}</strong> (#${e.id})</div>`)).join(""):'<div class="widget-item">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>'}),300)})),a.addEventListener("click",(n=>{const o=n.target.closest("[data-user-id]");if(o){const n=parseInt(o.dataset.userId),a=o.querySelector("strong").textContent;!async function(e,n,o){if(!confirm(`${o}ã•ã‚“ã‚’DMã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`))return;const{data:a}=await t.from("dm").select("member").eq("id",e).single();if(a.member.includes(n))return void alert("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«ãƒ¡ãƒ³ãƒãƒ¼ã§ã™ã€‚");const s=[...a.member,n],{error:r}=await t.from("dm").update({member:s}).eq("id",e);r?alert("ãƒ¡ãƒ³ãƒãƒ¼ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"):(await Y(e,`@${i.id}ã•ã‚“ãŒ@${n}ã•ã‚“ã‚’æ‹›å¾…ã—ã¾ã—ãŸ`),E(n,`@${i.id}ã•ã‚“ãŒã‚ãªãŸã‚’DMã«æ‹›å¾…ã—ã¾ã—ãŸã€‚`,`#dm/${e}`),alert("ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚"),openDmManageModal(e))}(e,n,a)}}))}else document.getElementById("leave-dm-btn").onclick=()=>async function(e){if(!confirm("æœ¬å½“ã«ã“ã®DMã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ"))return;w(!0);try{await Y(e,`@${i.id}ã•ã‚“ãŒé€€å‡ºã—ã¾ã—ãŸ`);const{error:n}=await t.rpc("leave_dm",{dm_id_to_leave:e,user_id_to_leave:i.id});if(n)throw n;alert("DMã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸã€‚"),v.dmManageModal.classList.add("hidden"),window.location.hash="#dm",await j()}catch(e){console.error("DMã‹ã‚‰ã®é€€å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ:",e),alert("DMã‹ã‚‰ã®é€€å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{w(!1)}}(e)}catch(e){v.dmManageModalContent.innerHTML=`<p style="padding: 1.5rem;">${e.message}</p>`,console.error(e)}},window.openCreateDmModal=function(){v.createDmModalContent.innerHTML='\n            <div style="padding: 1.5rem;">\n                <h3>æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>\n                <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã—ã¦DMã‚’é–‹å§‹ã—ã¾ã™ã€‚</p>\n                <input type="text" id="dm-user-search" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯IDã§æ¤œç´¢" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px;">\n                <div id="dm-user-search-results" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;"></div>\n            </div>\n        ';const e=v.createDmModalContent.querySelector("#dm-user-search"),n=v.createDmModalContent.querySelector("#dm-user-search-results");let o;e.addEventListener("input",(()=>{clearTimeout(o),o=setTimeout((async()=>{const o=e.value.trim();if(o.length<2)return void(n.innerHTML="");const{data:a,error:s}=await t.from("user").select("id, name, scid").or(`name.ilike.%${o}%,id.eq.${parseInt(o)||0}`).neq("id",i.id).limit(5);a&&a.length>0?n.innerHTML=a.map((e=>`\n                        <div class="widget-item" style="cursor: pointer;" data-user-id="${e.id}" data-user-name="${_(e.name)}">\n                            <strong>${_(e.name)}</strong> (#${e.id})\n                        </div>\n                    `)).join(""):n.innerHTML='<div class="widget-item">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>'}),300)})),n.addEventListener("click",(e=>{const t=e.target.closest("[data-user-id]");if(t){const e=parseInt(t.dataset.userId);v.createDmModal.classList.add("hidden"),G(e)}})),v.createDmModal.classList.remove("hidden"),v.createDmModal.querySelector(".modal-close-btn").onclick=()=>{v.createDmModal.classList.add("hidden")}},document.addEventListener("click",(e=>{const n=e.target,o=n.closest(".copy-btn");if(o){e.stopPropagation();const t=o.closest("pre"),n=o.closest(".inline-code-wrapper");let i="";return t?i=t.querySelector("code")?.textContent||"":n&&(i=n.querySelector("code")?.textContent||""),void(i&&navigator.clipboard.writeText(i).then((()=>{const e=o.innerHTML;o.innerHTML="Copied!",o.style.minWidth="50px",o.style.textAlign="center",setTimeout((()=>{o.innerHTML=e,o.style.minWidth="",o.style.textAlign=""}),1500)})).catch((e=>{console.error("Copy failed",e),o.innerHTML="Copy failed"})))}const a=n.closest(".post-menu-btn, .dm-message-menu-btn");if(a){let t;if(e.stopPropagation(),t=a.classList.contains("dm-message-menu-btn")?a.closest(".dm-message-container")?.querySelector(".post-menu"):a.closest(".post-header")?.querySelector(".post-menu"),t){const e=t.classList.contains("is-visible");document.querySelectorAll(".post-menu.is-visible").forEach((e=>{e.classList.remove("is-visible")})),e||t.classList.add("is-visible")}return}n.closest(".post-menu")||document.querySelectorAll(".post-menu.is-visible").forEach((e=>{e.classList.remove("is-visible")}));const s=n.closest(".edit-dm-msg-btn");if(s){const e=s.closest(".dm-message-container");return void Q(window.location.hash.substring(4),e.dataset.messageId)}const r=n.closest(".delete-dm-msg-btn");if(r){const e=r.closest(".dm-message-container");return void async function(e,n){if(confirm("ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹?")){w(!0);try{const{data:o,error:i}=await t.from("dm").select("post").eq("id",e).single();if(i)throw i;const a=o.post||[],s=a.find((e=>e.id===n)),r=a.filter((e=>e.id!==n));if(s&&s.attachments?.length>0){const e=s.attachments.map((e=>e.id));await z(e)}const{error:d}=await t.from("dm").update({post:r}).eq("id",e);if(d)throw d;document.querySelector(`.dm-message-container[data-message-id="${n}"]`)?.remove()}catch(e){console.error(e),alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{w(!1)}}}(window.location.hash.substring(4),e.dataset.messageId)}const d=n.closest(".edit-btn");if(d){const e=d.closest(".post");return void(e&&Z(e.dataset.postId))}const l=n.closest(".delete-btn:not(.delete-dm-msg-btn)");if(l){const e=l.closest(".post");return void(e&&window.deletePost(e.dataset.postId))}const c=n.closest(".post");if(c){const e=c.dataset.postId,o=c.dataset.actionTargetId||e;if(n.closest(".edit-btn"))return void Z(e);if(n.closest(".delete-btn"))return void window.deletePost(e);const i=n.closest(".reply-button");if(i)return void window.handleReplyClick(o,i.dataset.username);const a=n.closest(".like-button");if(a)return void window.handleLike(a,o);const s=n.closest(".star-button");if(s)return void window.handleStar(s,o);const r=n.closest(".repost-button");if(r)return void t.from("post").select("*, user(id, name, scid, icon_data, admin, verify)").eq("id",o).single().then((({data:e})=>{e&&D(e,r)}));if(!n.closest("a")&&!n.closest(".post-menu-btn")&&!n.closest(".attachment-item"))return void(window.location.hash=`#post/${o}`)}const m=n.closest(".notification-item");if(m){const o=m.dataset.notificationId,a=i.notice.find((e=>e.id===o));return n.closest(".notification-delete-btn")?(e.stopPropagation(),void t.rpc("delete_notification",{target_user_id:i.id,notification_id_to_delete:o}).then((({error:e})=>{e?(console.error("é€šçŸ¥ã®å‰Šé™¤ã«å¤±æ•—:",e),alert("é€šçŸ¥ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")):(i.notice=i.notice.filter((e=>e.id!==o)),m.remove())}))):(a&&!a.click&&t.rpc("mark_notification_as_read",{target_user_id:i.id,notification_id_to_update:o}).then((({error:e})=>{e?console.error("é€šçŸ¥ã®æ—¢èª­åŒ–ã«å¤±æ•—:",e):(a.click=!0,m.classList.remove("notification-new"))})),void(a&&a.open&&(window.location.hash=a.open)))}const p=n.closest(".timeline-tab-button");if(p)return void X(p.dataset.tab);if(n.closest("#banner-signup-button"))return void T();n.closest("#banner-login-button")&&T()})),v.retryConnectionBtn.addEventListener("click",(()=>{v.connectionErrorOverlay.classList.add("hidden"),I()})),window.addEventListener("hashchange",k),v.friezeOverlay.classList.add("hidden"),v.connectionErrorOverlay.classList.add("hidden"),I()}));
